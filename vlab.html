<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3D Chemistry Lab</title>
<style>
/* NO external fonts - zero network dependency */
*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;overflow:hidden;background:#0d1117;font-family:'Courier New',monospace;}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
#app{display:flex;flex-direction:column;width:100%;height:100%;}

#topbar{
  height:44px;min-height:44px;
  background:linear-gradient(90deg,#070c18,#0d1526,#070c18);
  border-bottom:1px solid rgba(0,210,255,.2);
  display:flex;align-items:center;justify-content:space-between;
  padding:0 20px;flex-shrink:0;
}
#topbar .logo{font-size:16px;font-weight:900;color:#00d4ff;letter-spacing:3px;text-shadow:0 0 14px rgba(0,212,255,.6);}
#topbar .ver{font-size:10px;color:#2a4060;letter-spacing:1px;}
#phdisp{
  font-size:11px;letter-spacing:1px;padding:4px 16px;
  border:1px solid rgba(0,212,255,.3);border-radius:20px;
  color:#00d4ff;background:rgba(0,212,255,.05);
  transition:all .6s;white-space:nowrap;min-width:130px;text-align:center;
}

#body{display:flex;flex:1;overflow:hidden;min-height:0;}

/* ‚îÄ‚îÄ LAB CANVAS AREA ‚îÄ‚îÄ */
#labwrap{
  flex:1;position:relative;overflow:hidden;
  background:linear-gradient(180deg,#8fa5c0 0%,#a8bdd4 45%,#6a7a95 45%,#4e5e78 100%);
}

/* Canvas for 3D room drawing */
#bgcanvas{position:absolute;top:0;left:0;width:100%;height:100%;display:block;}

/* Equipment overlay - sits ABOVE canvas, NO transforms */
#overlay{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;}

/* ‚îÄ‚îÄ EQUIPMENT ITEMS ‚îÄ‚îÄ all positioned via JS after layout measured ‚îÄ‚îÄ */
.eitem{position:absolute;pointer-events:all;}

/* === GLASSWARE STYLES === */
.glass-container{
  position:relative;
  border-radius:inherit;
  overflow:hidden;
  cursor:pointer;
  transition:filter .2s;
}
.glass-container:hover{filter:brightness(1.15);}

.liquid{
  position:absolute;bottom:0;left:0;right:0;
  transition:height 1.2s cubic-bezier(.4,0,.2,1), background-color 1.5s ease, background 1.5s ease;
  border-radius:0 0 inherit inherit;
}

.glass-shine{
  position:absolute;top:8px;left:6px;
  width:5px;border-radius:50%;
  background:rgba(255,255,255,.35);
  pointer-events:none;
}

.bubble-layer{position:absolute;inset:0;pointer-events:none;overflow:hidden;}

/* === BEAKER === */
.beaker-outer{
  background:rgba(180,220,255,.15);
  border:2px solid rgba(140,190,255,.55);
  border-radius:4px 4px 10px 10px;
  box-shadow:inset -5px 0 12px rgba(0,80,200,.12),3px 4px 14px rgba(0,0,0,.35);
}
.beaker-lip{
  position:absolute;top:-4px;left:-3px;right:-3px;height:7px;
  background:rgba(140,190,255,.32);border-radius:4px 4px 0 0;
}

/* === FLASK === */
.flask-neck{
  width:18px;height:28px;
  background:rgba(180,220,255,.18);
  border:2px solid rgba(140,190,255,.5);
  border-radius:3px 3px 0 0;
  margin:0 auto;position:relative;z-index:1;
}
.flask-body{
  background:rgba(180,220,255,.15);
  border:2px solid rgba(140,190,255,.52);
  border-radius:50% 50% 40% 40%;
  margin-top:-2px;
  box-shadow:inset -6px -6px 18px rgba(0,60,150,.15),4px 5px 18px rgba(0,0,0,.38);
}

/* === TEST TUBE === */
.test-tube{
  background:rgba(180,220,255,.15);
  border:2px solid rgba(140,190,255,.45);
  border-radius:3px 3px 12px 12px;
  box-shadow:inset -3px 0 8px rgba(0,80,200,.1);
  cursor:pointer;transition:transform .25s;
}
.test-tube:hover{transform:translateY(-8px);}

/* === BOTTLE === */
.bottle-body{
  background:rgba(180,220,255,.18);
  border:2px solid rgba(140,190,255,.4);
  border-radius:5px 5px 7px 7px;
  box-shadow:inset -4px 0 10px rgba(0,80,200,.08),3px 3px 12px rgba(0,0,0,.28);
}
.bottle-cap{border-radius:3px 3px 0 0;}
.bottle-neck{
  background:rgba(180,220,255,.18);
  border:2px solid rgba(140,190,255,.4);
  border-radius:2px 2px 0 0;
  margin:0 auto;
}
.bottle-label{
  position:absolute;top:30%;left:50%;transform:translateX(-50%);
  background:rgba(255,255,255,.88);color:#0a3060;
  font-size:8px;font-weight:700;padding:2px 4px;border-radius:2px;
  white-space:nowrap;z-index:2;pointer-events:none;
}

/* item label below each piece */
.ilabel{
  position:absolute;bottom:-18px;left:50%;transform:translateX(-50%);
  font-size:9px;color:rgba(150,185,235,.5);
  letter-spacing:1px;white-space:nowrap;text-transform:uppercase;
  pointer-events:none;
}

/* flash overlay for reaction */
.flash-over{
  position:absolute;inset:0;background:transparent;
  pointer-events:none;transition:background .15s;
  border-radius:inherit;
}

/* flame */
#flame-el{
  position:absolute;
  width:24px;height:50px;
  background:radial-gradient(ellipse at 50% 100%,#fff 0%,#ffe066 14%,#ff9500 44%,#ff3300 80%,transparent 100%);
  border-radius:50% 50% 28% 28%;
  animation:flk .12s infinite alternate;
  transform-origin:bottom center;
  opacity:0;transition:opacity .4s;
  pointer-events:none;
}
@keyframes flk{
  from{transform:scaleX(1) scaleY(1) rotate(-1deg);}
  to{transform:scaleX(.88) scaleY(1.1) rotate(1deg);}
}

/* steam */
.steam-p{
  position:absolute;border-radius:50%;
  background:rgba(255,255,255,.4);
  animation:stm 2.2s ease-out forwards;pointer-events:none;
}
@keyframes stm{
  0%{opacity:.7;transform:translateY(0) translateX(0) scale(.5);}
  100%{opacity:0;transform:translateY(-75px) translateX(var(--sx,10px)) scale(2.5);}
}
.bub{
  position:absolute;border-radius:50%;
  background:rgba(255,255,255,.55);
  animation:brise 1.6s ease-in forwards;pointer-events:none;
}
@keyframes brise{0%{opacity:.8;transform:translateY(0);}100%{opacity:0;transform:translateY(-55px);}}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
#sidebar{
  width:252px;min-width:252px;
  background:linear-gradient(180deg,#060b15,#09101e);
  border-left:1px solid rgba(0,210,255,.12);
  display:flex;flex-direction:column;overflow:hidden;
}

#expsel{padding:12px;border-bottom:1px solid rgba(0,210,255,.1);}
#expsel h3{font-size:10px;color:#00d4ff;letter-spacing:2px;margin-bottom:9px;font-weight:normal;}
.eopt{
  padding:8px 10px;margin-bottom:5px;
  border:1px solid #162030;border-radius:6px;
  cursor:pointer;font-size:10px;color:#4a6a8a;
  transition:all .2s;line-height:1.5;
}
.eopt:hover{border-color:rgba(0,212,255,.35);color:#88aabb;background:rgba(0,212,255,.04);}
.eopt.act{border-color:#00d4ff;color:#00d4ff;background:rgba(0,212,255,.07);}

#ctrl{padding:12px;border-bottom:1px solid rgba(0,210,255,.1);flex-shrink:0;}
#ctrl h3{font-size:10px;color:#00d4ff;letter-spacing:2px;margin-bottom:9px;font-weight:normal;}

.lbtn{
  display:block;width:100%;padding:9px 12px;margin-bottom:6px;
  border-radius:6px;border:1px solid;background:transparent;
  font-family:'Courier New',monospace;font-size:11px;letter-spacing:.8px;
  cursor:pointer;transition:all .2s;text-transform:uppercase;text-align:left;
}
.lbtn:disabled{opacity:.25;cursor:not-allowed;}
.r{border-color:#ff4455;color:#ff4455;}
.r:hover:not(:disabled){background:rgba(255,68,85,.13);box-shadow:0 0 10px rgba(255,68,85,.25);}
.b{border-color:#00d4ff;color:#00d4ff;}
.b:hover:not(:disabled){background:rgba(0,212,255,.1);box-shadow:0 0 10px rgba(0,212,255,.25);}
.o{border-color:#ff9500;color:#ff9500;}
.o:hover:not(:disabled){background:rgba(255,149,0,.1);box-shadow:0 0 10px rgba(255,149,0,.25);}
.p{border-color:#c077ff;color:#c077ff;}
.p:hover:not(:disabled){background:rgba(192,119,255,.1);box-shadow:0 0 10px rgba(192,119,255,.25);}
.g{border-color:#33ee88;color:#33ee88;}
.g:hover:not(:disabled){background:rgba(51,238,136,.1);box-shadow:0 0 10px rgba(51,238,136,.25);}
.x{border-color:#334455;color:#667788;}
.x:hover:not(:disabled){background:rgba(51,68,85,.2);}

/* pH bar */
#phbar-wrap{margin:8px 12px;flex-shrink:0;}
#phbar-track{
  height:13px;border-radius:6px;
  background:linear-gradient(90deg,#ff2244,#ff8800,#eeee00,#33dd66,#0088ff,#8800cc);
  position:relative;border:1px solid #1a2a3a;overflow:visible;
}
#phneedle{
  position:absolute;top:-5px;width:3px;height:23px;
  background:#fff;border-radius:2px;
  box-shadow:0 0 7px rgba(255,255,255,.8);
  transition:left 1s ease;left:50%;transform:translateX(-50%);
}
#phlabels{display:flex;justify-content:space-between;padding:2px 0;font-size:9px;color:#334455;}

/* log */
#logwrap{flex:1;overflow-y:auto;padding:10px 12px;min-height:0;}
#logwrap h3{font-size:9px;color:#2a4055;letter-spacing:2px;margin-bottom:7px;font-weight:normal;}
.le{
  font-size:10px;line-height:1.6;padding:4px 8px;margin-bottom:3px;
  border-left:2px solid #162030;color:#3a5568;
  animation:lein .3s ease;
}
@keyframes lein{from{opacity:0;transform:translateX(-4px);}to{opacity:1;transform:none;}}
.le.h{border-left-color:#00d4ff;color:#7aaacc;}
.le.w{border-left-color:#ff9500;color:#bb7700;}
.le.s{border-left-color:#33ee88;color:#18994a;}
.le.rx{border-left-color:#c077ff;color:#9944cc;}
</style>
</head>
<body>
<div id="app">

  <div id="topbar">
    <div class="logo">‚öó CHEM LAB 3D</div>
    <div class="ver">VIRTUAL LABORATORY v3.0</div>
    <div id="phdisp">pH: ‚Äî</div>
  </div>

  <div id="body">
    <div id="labwrap">
      <canvas id="bgcanvas"></canvas>
      <div id="overlay">
        <!-- All equipment divs injected here by JS -->
        <div id="flame-el"></div>
        <div id="steam-container"></div>
      </div>
    </div>

    <div id="sidebar">
      <div id="expsel">
        <h3>‚ñ∏ SELECT EXPERIMENT</h3>
        <div class="eopt act" onclick="selExp(0,this)">
          üî¥ Acid-Base Neutralisation<br>
          <span style="color:#1e3248;font-size:9px">HCl + NaOH ‚Üí NaCl + H‚ÇÇO</span>
        </div>
        <div class="eopt" onclick="selExp(1,this)">
          üü† Combustion Reaction<br>
          <span style="color:#1e3248;font-size:9px">CH‚ÇÑ + 2O‚ÇÇ ‚Üí CO‚ÇÇ + 2H‚ÇÇO</span>
        </div>
        <div class="eopt" onclick="selExp(2,this)">
          üü¢ Acid-Base Titration<br>
          <span style="color:#1e3248;font-size:9px">CH‚ÇÉCOOH + NaOH ‚Üí Salt</span>
        </div>
        <div class="eopt" onclick="selExp(3,this)">
          üü£ Redox Reaction<br>
          <span style="color:#1e3248;font-size:9px">KMnO‚ÇÑ + H‚ÇÇO‚ÇÇ ‚Üí MnO‚ÇÇ</span>
        </div>
      </div>

      <div id="ctrl">
        <h3>‚ñ∏ CONTROLS</h3>
        <div id="btns"></div>
      </div>

      <div id="phbar-wrap">
        <div id="phbar-track"><div id="phneedle"></div></div>
        <div id="phlabels"><span>0</span><span>3</span><span>7</span><span>10</span><span>14</span></div>
      </div>

      <div id="logwrap">
        <h3>‚ñ∏ LAB JOURNAL</h3>
        <div id="loglist"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CANVAS 3D ROOM RENDERER
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const canvas = document.getElementById('bgcanvas');
const ctx = canvas.getContext('2d');

function resizeCanvas(){
  const wrap = document.getElementById('labwrap');
  canvas.width = wrap.clientWidth;
  canvas.height = wrap.clientHeight;
  drawRoom();
  positionEquipment();
}

function drawRoom(){
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);

  // Horizon line (where wall meets floor)
  const hor = H * 0.62;
  // Vanishing point
  const vpx = W * 0.5, vpy = H * 0.2;

  /* ‚îÄ‚îÄ BACK WALL ‚îÄ‚îÄ */
  const wallGrad = ctx.createLinearGradient(0, 0, 0, hor);
  wallGrad.addColorStop(0, '#b8cfe0');
  wallGrad.addColorStop(1, '#cddaec');
  ctx.fillStyle = wallGrad;
  ctx.fillRect(0, 0, W, hor);

  // Wall grid lines
  ctx.strokeStyle = 'rgba(0,0,0,0.04)';
  ctx.lineWidth = 1;
  for(let x=0; x<W; x+=100){ ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,hor);ctx.stroke(); }
  for(let y=0; y<hor; y+=90){ ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke(); }

  /* ‚îÄ‚îÄ LEFT SIDE WALL ‚îÄ‚îÄ */
  ctx.beginPath();
  ctx.moveTo(0, 0);
  ctx.lineTo(W*0.08, vpy);
  ctx.lineTo(W*0.08, hor);
  ctx.lineTo(0, hor);
  ctx.closePath();
  const lwGrad = ctx.createLinearGradient(0,0,W*0.08,0);
  lwGrad.addColorStop(0,'#8898b8'); lwGrad.addColorStop(1,'#aabbd0');
  ctx.fillStyle = lwGrad; ctx.fill();

  /* ‚îÄ‚îÄ RIGHT SIDE WALL ‚îÄ‚îÄ */
  ctx.beginPath();
  ctx.moveTo(W, 0);
  ctx.lineTo(W*0.92, vpy);
  ctx.lineTo(W*0.92, hor);
  ctx.lineTo(W, hor);
  ctx.closePath();
  const rwGrad = ctx.createLinearGradient(W,0,W*0.92,0);
  rwGrad.addColorStop(0,'#8898b8'); rwGrad.addColorStop(1,'#aabbd0');
  ctx.fillStyle = rwGrad; ctx.fill();

  /* ‚îÄ‚îÄ FLOOR ‚îÄ‚îÄ */
  ctx.beginPath();
  ctx.moveTo(0, hor); ctx.lineTo(W, hor); ctx.lineTo(W, H); ctx.lineTo(0, H);
  ctx.closePath();
  const flGrad = ctx.createLinearGradient(0, hor, 0, H);
  flGrad.addColorStop(0,'#6a7a96'); flGrad.addColorStop(1,'#46566e');
  ctx.fillStyle = flGrad; ctx.fill();

  // Floor tiles - perspective lines
  ctx.strokeStyle = 'rgba(255,255,255,0.07)';
  ctx.lineWidth = 1;
  // Horizontal floor lines (perspective)
  for(let i=1; i<=5; i++){
    const y = hor + (H-hor)*i/5;
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke();
  }
  // Vertical floor lines (converge to VP)
  for(let x=0; x<=W; x+=W/8){
    ctx.beginPath(); ctx.moveTo(vpx, hor); ctx.lineTo(x, H); ctx.stroke();
  }

  /* ‚îÄ‚îÄ CEILING LIGHT ‚îÄ‚îÄ */
  const lightX = W/2, lightW = W*0.28;
  ctx.fillStyle = 'rgba(255,255,255,0.92)';
  ctx.fillRect(lightX - lightW/2, 0, lightW, 8);
  // Glow
  const glowGrad = ctx.createRadialGradient(lightX,4,0,lightX,4,lightW/2);
  glowGrad.addColorStop(0,'rgba(210,235,255,0.55)');
  glowGrad.addColorStop(1,'rgba(210,235,255,0)');
  ctx.fillStyle = glowGrad;
  ctx.ellipse(lightX, 4, lightW/2, 80, 0, 0, Math.PI*2);
  ctx.fill();

  /* ‚îÄ‚îÄ BLACKBOARD ‚îÄ‚îÄ */
  const bbx = W*0.04, bby = H*0.03, bbw = W*0.24, bbh = H*0.35;
  ctx.fillStyle = '#1a2e18';
  roundRect(ctx, bbx, bby, bbw, bbh, 5);
  ctx.fill();
  ctx.strokeStyle = '#3d2e14'; ctx.lineWidth = 9;
  roundRect(ctx, bbx, bby, bbw, bbh, 5);
  ctx.stroke();
  // BB text
  ctx.fillStyle = 'rgba(215,225,195,0.72)';
  ctx.font = '12px Courier New';
  ctx.fillText('HCl + NaOH ‚Üí', bbx+14, bby+30);
  ctx.fillStyle = 'rgba(255,230,80,0.75)';
  ctx.fillText('  NaCl + H‚ÇÇO', bbx+14, bby+52);
  ctx.fillStyle = 'rgba(215,225,195,0.55)';
  ctx.fillText('Neutralisation', bbx+14, bby+72);
  ctx.fillText('ŒîH = ‚àí57.3 kJ/mol', bbx+14, bby+94);
  ctx.fillStyle = 'rgba(255,230,80,0.7)';
  ctx.fillText('pH indicator:', bbx+14, bby+118);
  ctx.fillStyle = 'rgba(215,225,195,0.55)';
  ctx.fillText('Phenolphthalein', bbx+14, bby+138);
  // BB tray
  ctx.fillStyle = '#4d3d1e';
  ctx.fillRect(bbx-2, bby+bbh, bbw+4, 9);

  /* ‚îÄ‚îÄ WINDOW ‚îÄ‚îÄ */
  const wx = W*0.72, wy = H*0.04, ww = W*0.2, wh = H*0.33;
  const winGrad = ctx.createLinearGradient(wx,wy,wx+ww,wy+wh);
  winGrad.addColorStop(0,'#a0c8ff'); winGrad.addColorStop(1,'#c8e0ff');
  ctx.fillStyle = winGrad;
  roundRect(ctx,wx,wy,ww,wh,3); ctx.fill();
  // Window glow
  ctx.shadowColor = 'rgba(120,180,255,0.5)'; ctx.shadowBlur = 25;
  ctx.strokeStyle = '#3a4a68'; ctx.lineWidth = 10;
  roundRect(ctx,wx,wy,ww,wh,3); ctx.stroke();
  ctx.shadowBlur = 0;
  // Panes
  ctx.strokeStyle = '#3a4a68'; ctx.lineWidth = 4;
  ctx.beginPath();ctx.moveTo(wx,wy+wh/2);ctx.lineTo(wx+ww,wy+wh/2);ctx.stroke();
  ctx.beginPath();ctx.moveTo(wx+ww/2,wy);ctx.lineTo(wx+ww/2,wy+wh);ctx.stroke();

  /* ‚îÄ‚îÄ BACK WALL CABINETS ‚îÄ‚îÄ */
  const cabY = H*0.02, cabH = H*0.38;
  const cabStartX = W*0.32, cabEndX = W*0.70;
  const numCabs = 5, cabW = (cabEndX-cabStartX)/numCabs;
  const glassIdxs = [1,2,4];
  for(let i=0;i<numCabs;i++){
    const cx = cabStartX + i*cabW;
    ctx.fillStyle = glassIdxs.includes(i) ? 'rgba(140,180,220,0.1)' : '#2d3d5a';
    ctx.strokeStyle = 'rgba(255,255,255,0.07)'; ctx.lineWidth = 1;
    roundRect(ctx,cx+2,cabY,cabW-4,cabH,3);
    ctx.fill(); ctx.stroke();
    // Door inset
    ctx.fillStyle = 'rgba(255,255,255,0.03)';
    ctx.strokeStyle = 'rgba(255,255,255,0.09)'; ctx.lineWidth = 1;
    roundRect(ctx,cx+9,cabY+8,cabW-18,cabH-18,2);
    ctx.fill(); ctx.stroke();
    // Handle
    ctx.fillStyle = 'rgba(255,255,255,0.22)';
    ctx.fillRect(cx+cabW/2-10, cabY+cabH-16, 20, 5);
  }

  /* ‚îÄ‚îÄ LAB BENCH ‚îÄ‚îÄ */
  const benchY = hor - 2;
  const benchTop = 22, benchFront = 75;
  const bx = W*0.05, bw = W*0.9;

  // Bench side shadow
  ctx.fillStyle = '#0a1020';
  ctx.fillRect(bx-12, benchY, 12, benchTop+benchFront);
  ctx.fillRect(bx+bw, benchY, 12, benchTop+benchFront);

  // Bench top surface
  const btGrad = ctx.createLinearGradient(0, benchY, 0, benchY+benchTop);
  btGrad.addColorStop(0,'#4a62a0'); btGrad.addColorStop(0.5,'#2e3e7c'); btGrad.addColorStop(1,'#1e2e5c');
  ctx.fillStyle = btGrad;
  roundRect(ctx,bx,benchY,bw,benchTop,4);
  ctx.fill();
  // Bench top sheen
  ctx.fillStyle = 'rgba(255,255,255,0.16)';
  ctx.fillRect(bx+bw*0.1, benchY+3, bw*0.8, 3);

  // Bench front
  const bfGrad = ctx.createLinearGradient(0, benchY+benchTop, 0, benchY+benchTop+benchFront);
  bfGrad.addColorStop(0,'#182240'); bfGrad.addColorStop(1,'#0d1528');
  ctx.fillStyle = bfGrad;
  roundRect(ctx,bx,benchY+benchTop,bw,benchFront,4);
  ctx.fill();

  // Bench drawers
  const numD = 7, dw = bw/numD;
  ctx.strokeStyle = 'rgba(255,255,255,0.04)'; ctx.lineWidth = 1;
  for(let i=1;i<numD;i++){
    ctx.beginPath();
    ctx.moveTo(bx+i*dw, benchY+benchTop);
    ctx.lineTo(bx+i*dw, benchY+benchTop+benchFront);
    ctx.stroke();
  }
  // Drawer handles
  ctx.fillStyle = 'rgba(255,255,255,0.12)';
  for(let i=0;i<numD;i++){
    ctx.fillRect(bx+i*dw+dw/2-12, benchY+benchTop+benchFront/2-3, 24, 5);
  }

  // Store bench geometry for equipment placement
  window.benchGeo = {
    x: bx, y: benchY, w: bw,
    surfaceY: benchY  // top of bench surface = base for equipment
  };
}

function roundRect(ctx, x, y, w, h, r){
  ctx.beginPath();
  ctx.moveTo(x+r, y);
  ctx.lineTo(x+w-r, y); ctx.arcTo(x+w,y,x+w,y+r,r);
  ctx.lineTo(x+w, y+h-r); ctx.arcTo(x+w,y+h,x+w-r,y+h,r);
  ctx.lineTo(x+r, y+h); ctx.arcTo(x,y+h,x,y+h-r,r);
  ctx.lineTo(x, y+r); ctx.arcTo(x,y,x+r,y,r);
  ctx.closePath();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   EQUIPMENT DOM BUILDER
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let eqBuilt = false;

function positionEquipment(){
  if(!window.benchGeo) return;
  const ov = document.getElementById('overlay');
  const {x, y, w} = window.benchGeo;

  // Clear previous equipment (not flame/steam)
  ov.querySelectorAll('.eitem').forEach(e=>e.remove());

  const baseY = y; // Equipment sits on top of bench

  // Equipment positions as fractions of bench width + offsets
  const positions = [
    // [id, left fraction along bench, width, height above bench]
    {id:'stand_group',  lf:0.04, W:88,  H:220},
    {id:'bset_group',   lf:0.19, W:80,  H:180},
    {id:'cyl_group',    lf:0.32, W:36,  H:130},
    {id:'water_group',  lf:0.40, W:44,  H:125},
    {id:'alc_group',    lf:0.47, W:40,  H:118},
    {id:'rack_group',   lf:0.55, W:116, H:95},
    {id:'scope_group',  lf:0.73, W:72,  H:115},
  ];

  positions.forEach(p=>{
    const el = document.createElement('div');
    el.className = 'eitem';
    el.id = p.id;
    el.style.cssText = `left:${x + w*p.lf}px;top:${baseY - p.H}px;width:${p.W}px;height:${p.H}px;`;
    ov.appendChild(el);
  });

  buildRetortStand();
  buildBurnerSet();
  buildCylinder();
  buildWaterBottle();
  buildAlcBottle();
  buildRack();
  buildMicroscope();
  positionFlame();
}

function buildRetortStand(){
  const g = document.getElementById('stand_group');
  g.innerHTML = `
    <div style="position:absolute;bottom:0;left:35px;width:8px;height:100%;background:linear-gradient(90deg,#666,#aaa,#666);border-radius:4px;box-shadow:2px 0 7px rgba(0,0,0,.4)">
      <div style="position:absolute;right:-27px;top:65px;width:25px;height:10px;background:linear-gradient(180deg,#888,#555);border-radius:3px;"></div>
      <div style="position:absolute;right:-44px;top:57px;width:30px;height:25px;border:3px solid #888;border-radius:50%;"></div>
    </div>
    <div style="position:absolute;bottom:0;left:0;right:0;height:11px;background:linear-gradient(180deg,#888,#444);border-radius:3px;box-shadow:0 4px 9px rgba(0,0,0,.5);"></div>
    <div id="flask_wrap" style="position:absolute;left:34px;bottom:78px;">
      <div class="flask-neck"></div>
      <div id="flask_body" class="flask-body glass-container" style="width:60px;height:64px;position:relative;overflow:hidden;">
        <div id="flask_liq" class="liquid" style="height:0%;background:linear-gradient(rgba(255,80,50,.65),rgba(200,30,10,.92));border-radius:0 0 40% 40%;"></div>
        <div class="glass-shine" style="height:18px;"></div>
        <div id="flask_flash" class="flash-over"></div>
      </div>
    </div>
    <div class="ilabel">Erlenmeyer</div>
  `;
}

function buildBurnerSet(){
  const g = document.getElementById('bset_group');
  g.innerHTML = `
    <div style="position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:34px;height:9px;background:linear-gradient(180deg,#555,#222);border-radius:3px;box-shadow:0 3px 7px rgba(0,0,0,.5);"></div>
    <div style="position:absolute;bottom:9px;left:50%;transform:translateX(-50%);width:14px;height:28px;background:linear-gradient(90deg,#555,#888,#555);border-radius:3px 3px 0 0;position:relative;">
      <div style="position:absolute;bottom:9px;left:50%;transform:translateX(-50%);width:14px;height:28px;background:linear-gradient(90deg,#555,#888,#555);border-radius:3px 3px 0 0;">
        <div style="position:absolute;right:-11px;bottom:0;width:5px;height:10px;background:#444;border-radius:2px;"></div>
      </div>
    </div>
    <div style="position:absolute;bottom:37px;left:50%;transform:translateX(-50%);width:52px;height:7px;background:repeating-linear-gradient(90deg,#555 0,#555 3px,transparent 3px,transparent 8px);border:1px solid #555;border-radius:2px;"></div>
    <div style="position:absolute;bottom:37px;left:50%;transform:translateX(-50%);width:60px;height:38px;">
      <div style="position:absolute;bottom:0;left:5px;width:3px;height:36px;background:#666;border-radius:2px;transform:rotate(13deg);transform-origin:bottom;"></div>
      <div style="position:absolute;bottom:0;right:5px;width:3px;height:36px;background:#666;border-radius:2px;transform:rotate(-13deg);transform-origin:bottom;"></div>
    </div>
    <div id="beaker_wrap" style="position:absolute;bottom:75px;left:50%;transform:translateX(-50%);width:56px;">
      <div id="beaker_el" class="beaker-outer glass-container" style="width:56px;height:64px;position:relative;overflow:hidden;">
        <div class="beaker-lip"></div>
        <div class="glass-shine" style="height:17px;"></div>
        <div id="beaker_liq" class="liquid" style="height:0%;background:linear-gradient(rgba(0,180,120,.55),rgba(0,140,80,.9));border-radius:0 0 8px 8px;"></div>
        <div id="beaker_bub" class="bubble-layer"></div>
      </div>
    </div>
    <div class="ilabel" style="bottom:-18px;left:38px;">Beaker</div>
    <div id="steam_here" style="position:absolute;bottom:60px;left:10px;width:60px;height:80px;pointer-events:none;overflow:visible;"></div>
  `;
}

function buildCylinder(){
  const g = document.getElementById('cyl_group');
  g.innerHTML = `
    <div style="width:26px;height:108px;margin:0 auto;background:rgba(180,220,255,.16);border:2px solid rgba(140,190,255,.4);border-radius:3px 3px 8px 8px;position:relative;overflow:hidden;box-shadow:inset -3px 0 8px rgba(0,80,200,.1);">
      <div style="position:absolute;right:3px;top:6px;display:flex;flex-direction:column;gap:11px;">
        <div style="width:6px;height:1px;background:rgba(100,160,220,.55);"></div>
        <div style="width:6px;height:1px;background:rgba(100,160,220,.55);"></div>
        <div style="width:6px;height:1px;background:rgba(100,160,220,.55);"></div>
        <div style="width:6px;height:1px;background:rgba(100,160,220,.55);"></div>
        <div style="width:6px;height:1px;background:rgba(100,160,220,.55);"></div>
      </div>
      <div id="cyl_liq" class="liquid" style="height:38%;background:linear-gradient(rgba(0,150,255,.42),rgba(0,100,200,.78));border-radius:0 0 6px 6px;"></div>
    </div>
    <div style="width:38px;height:7px;background:rgba(120,180,255,.25);border:1px solid rgba(120,180,255,.35);border-radius:3px;margin-left:-6px;"></div>
    <div class="ilabel">Cylinder</div>
  `;
}

function buildWaterBottle(){
  const g = document.getElementById('water_group');
  g.innerHTML = `
    <div style="width:16px;height:10px;background:linear-gradient(#1a88cc,#0a5588);border-radius:3px 3px 0 0;margin:0 auto;"></div>
    <div style="width:13px;height:22px;background:rgba(180,220,255,.26);border:2px solid rgba(140,190,255,.38);border-radius:2px 2px 0 0;margin:0 auto;"></div>
    <div class="bottle-body" style="width:44px;height:94px;position:relative;overflow:hidden;">
      <div class="liquid" style="position:absolute;bottom:0;width:100%;height:70%;background:linear-gradient(rgba(150,210,255,.35),rgba(80,160,240,.7));border-radius:0 0 5px 5px;"></div>
      <div class="bottle-label">H‚ÇÇO</div>
    </div>
    <div class="ilabel">Water</div>
  `;
}

function buildAlcBottle(){
  const g = document.getElementById('alc_group');
  g.innerHTML = `
    <div style="width:15px;height:10px;background:linear-gradient(#883300,#551100);border-radius:3px 3px 0 0;margin:0 auto;"></div>
    <div style="width:12px;height:20px;background:rgba(255,220,120,.22);border:2px solid rgba(220,180,80,.38);border-radius:2px 2px 0 0;margin:0 auto;"></div>
    <div style="width:40px;height:88px;background:rgba(255,220,120,.16);border:2px solid rgba(220,180,80,.38);border-radius:5px 5px 7px 7px;position:relative;overflow:hidden;box-shadow:inset -4px 0 10px rgba(180,120,0,.08),3px 3px 12px rgba(0,0,0,.28);">
      <div class="liquid" style="position:absolute;bottom:0;width:100%;height:56%;background:linear-gradient(rgba(255,200,50,.28),rgba(200,140,0,.62));border-radius:0 0 5px 5px;"></div>
      <div class="bottle-label" style="color:#441100;background:rgba(255,240,190,.9)">EtOH</div>
    </div>
    <div class="ilabel">Alcohol</div>
  `;
}

function buildRack(){
  const g = document.getElementById('rack_group');
  g.innerHTML = `
    <div style="width:115px;height:12px;background:linear-gradient(180deg,#777,#444);border-radius:4px;box-shadow:0 3px 7px rgba(0,0,0,.4);position:relative;z-index:2;">
      ${[0,1,2,3].map(i=>`
        <div id="tt${i}" class="test-tube" style="position:absolute;bottom:10px;left:${8+i*28}px;width:16px;height:70px;">
          <div id="ttl${i}" class="liquid" style="height:${[42,54,37,50][i]}%;background:${['linear-gradient(rgba(255,80,80,.5),rgba(200,30,30,.9))','linear-gradient(rgba(80,180,255,.5),rgba(0,130,220,.9))','linear-gradient(rgba(80,220,130,.5),rgba(0,170,80,.9))','linear-gradient(rgba(200,140,255,.5),rgba(140,50,220,.9))'][i]};border-radius:0 0 10px 10px;"></div>
        </div>
      `).join('')}
    </div>
    <div style="width:97px;height:13px;background:linear-gradient(180deg,#555,#333);border-radius:0 0 4px 4px;margin:0 auto;"></div>
    <div class="ilabel" style="left:50%">Test Tubes</div>
  `;
}

function buildMicroscope(){
  const g = document.getElementById('scope_group');
  g.innerHTML = `
    <div style="position:absolute;bottom:11px;left:30px;width:9px;height:88px;background:linear-gradient(90deg,#777,#999,#666);border-radius:4px;"></div>
    <div style="position:absolute;bottom:90px;left:8px;width:36px;height:17px;background:linear-gradient(180deg,#888,#555);border-radius:5px;transform:rotate(-10deg);"></div>
    <div style="position:absolute;bottom:103px;left:26px;width:10px;height:25px;background:linear-gradient(180deg,#999,#666);border-radius:4px;"></div>
    <div style="position:absolute;bottom:72px;left:31px;width:8px;height:19px;background:linear-gradient(180deg,#666,#333);border-radius:0 0 4px 4px;"></div>
    <div style="position:absolute;bottom:48px;left:12px;width:42px;height:6px;background:linear-gradient(180deg,#888,#555);border-radius:2px;"></div>
    <div style="position:absolute;bottom:0;left:0;right:0;height:11px;background:linear-gradient(180deg,#666,#333);border-radius:4px;box-shadow:0 4px 9px rgba(0,0,0,.5);"></div>
    <div class="ilabel">Microscope</div>
  `;
}

function positionFlame(){
  if(!window.benchGeo) return;
  const g = document.getElementById('bset_group');
  if(!g) return;
  const flame = document.getElementById('flame-el');
  const rect = g.getBoundingClientRect();
  const labRect = document.getElementById('labwrap').getBoundingClientRect();
  const bkEl = document.getElementById('beaker_wrap');
  if(!bkEl) return;
  const bkRect = bkEl.getBoundingClientRect();
  flame.style.cssText = `
    position:absolute;
    left:${bkRect.left - labRect.left + bkRect.width/2 - 12}px;
    top:${bkRect.top - labRect.top + bkRect.height + 14}px;
    width:24px;height:50px;
    opacity:0;
  `;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HELPERS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const tmrs = [];
let S = {};

function setLiq(id, h, bg){
  const el = document.getElementById(id);
  if(!el) return;
  el.style.height = h + '%';
  if(bg) el.style.background = bg;
}

function doFlash(id){
  const el = document.getElementById(id);
  if(!el) return;
  el.style.background = 'rgba(255,255,255,.65)';
  setTimeout(()=>{ el.style.background='transparent'; }, 280);
}

function flameOn(on){
  const f = document.getElementById('flame-el');
  if(f) f.style.opacity = on ? '1' : '0';
}

function startBoiling(){
  const iv = setInterval(()=>{
    const bb = document.getElementById('beaker_bub');
    if(bb){
      for(let i=0;i<3;i++){
        const b=document.createElement('div');
        b.className='bub';
        b.style.cssText=`width:${3+Math.random()*5}px;height:${3+Math.random()*5}px;left:${4+Math.random()*38}px;bottom:${4+Math.random()*14}px;animation-delay:${Math.random()*.6}s;animation-duration:${.9+Math.random()*.9}s`;
        bb.appendChild(b); setTimeout(()=>b.remove(),2000);
      }
    }
    const sh = document.getElementById('steam_here');
    if(sh){
      for(let i=0;i<2;i++){
        const s=document.createElement('div');
        s.className='steam-p';
        s.style.cssText=`width:${7+Math.random()*9}px;height:${7+Math.random()*9}px;left:${8+Math.random()*28}px;bottom:${20+Math.random()*18}px;--sx:${(Math.random()-.5)*36}px;animation-delay:${Math.random()*.4}s;animation-duration:${1.8+Math.random()}s`;
        sh.appendChild(s); setTimeout(()=>s.remove(),3000);
      }
    }
  }, 340);
  tmrs.push(iv);
}

function stopBoiling(){
  const bb=document.getElementById('beaker_bub');
  const sh=document.getElementById('steam_here');
  if(bb) bb.innerHTML='';
  if(sh) sh.innerHTML='';
}

function setPH(v){
  const n=document.getElementById('phneedle');
  const d=document.getElementById('phdisp');
  if(v===null||v===undefined){
    n.style.left='50%'; d.textContent='pH: ‚Äî';
    d.style.color='#00d4ff'; d.style.borderColor='rgba(0,212,255,.3)';
    return;
  }
  n.style.left=(v/14*100)+'%';
  d.textContent=`pH: ${(+v).toFixed(1)}`;
  const h=v<7?Math.round(v/7*55):v===7?120:Math.round(120+(v-7)/7*220);
  d.style.color=`hsl(${h},80%,62%)`;
  d.style.borderColor=`hsla(${h},80%,55%,.45)`;
}

function setHead(t){ document.getElementById('phdisp').textContent=t; }

function log(msg, cls=''){
  const d=document.createElement('div');
  d.className='le'+(cls?' '+cls:'');
  const ts=new Date().toLocaleTimeString('en',{hour12:false});
  d.textContent=`[${ts}] ${msg}`;
  const list=document.getElementById('loglist');
  list.prepend(d);
  while(list.children.length>35) list.removeChild(list.lastChild);
}

function clearTmrs(){ tmrs.forEach(t=>{try{clearInterval(t);}catch(e){}});  tmrs.length=0; }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   EXPERIMENTS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const EXPS = [

  /* 0 ‚îÄ Acid-Base Neutralisation */
  { name:'Acid-Base Neutralisation', steps:[
    { lbl:'‚ûï Add HCl (Acid)', cls:'r',
      run(){
        setLiq('flask_liq', 44, 'linear-gradient(rgba(255,80,50,.65),rgba(200,30,10,.92))');
        setLiq('beaker_liq', 32, 'linear-gradient(rgba(255,140,80,.55),rgba(220,80,30,.88))');
        setLiq('cyl_liq', 54, 'linear-gradient(rgba(255,130,60,.5),rgba(210,60,20,.82))');
        setLiq('ttl0', 62, 'linear-gradient(rgba(255,60,60,.6),rgba(220,20,20,.95))');
        setPH(2);
        log('Added 20 mL HCl. Solution is strongly acidic.','h');
        log('Colour: pale yellow. pH = 2.0','');
        S.acid=true; rb();
      }
    },
    { lbl:'‚ûï Add NaOH (Base)', cls:'b', req:'acid',
      run(){
        doFlash('flask_flash');
        setLiq('flask_liq', 67, 'linear-gradient(rgba(0,220,160,.55),rgba(0,170,120,.92))');
        setLiq('beaker_liq', 54, 'linear-gradient(rgba(0,200,200,.52),rgba(0,150,180,.88))');
        setLiq('ttl1', 68, 'linear-gradient(rgba(0,210,255,.6),rgba(0,130,220,.95))');
        setPH(7);
        log('Added NaOH dropwise ‚Äî neutralisation!','rx');
        log('NaCl + H‚ÇÇO formed. ŒîH = ‚àí57.3 kJ/mol','rx');
        log('‚úÖ pH = 7.0 ‚Äî equivalence point!','s');
        S.base=true; rb();
      }
    },
    { lbl:'üî• Heat Solution', cls:'o', req:'base',
      run(){
        flameOn(true);
        log('Heating started. Temperature rising...','h');
        let t=25;
        const iv=setInterval(()=>{
          t=Math.min(100,t+3);
          setHead(`pH: 7.0 | Temp: ${t}¬∞C`);
          if(t>=100){ clearInterval(iv); startBoiling(); log('Boiling! NaCl concentration increasing.','w'); }
        },160);
        tmrs.push(iv);
      }
    },
    { lbl:'üíú Add Indicator', cls:'p', req:'acid',
      run(){
        const h=S.base?67:44, bh=S.base?54:32;
        setLiq('flask_liq', h, 'linear-gradient(rgba(200,120,255,.58),rgba(140,20,220,.92))');
        setLiq('beaker_liq', bh, 'linear-gradient(rgba(200,120,255,.52),rgba(140,20,220,.88))');
        setLiq('ttl3', 62, 'linear-gradient(rgba(220,150,255,.6),rgba(150,20,220,.95))');
        log('Phenolphthalein added.','rx');
        log(S.base?'Neutral ‚Üí pale pink.':'Acidic ‚Üí colourless.','h');
      }
    },
    { lbl:'‚Ü∫ Reset Lab', cls:'x', run(){ resetLab(); } }
  ]},

  /* 1 ‚îÄ Combustion */
  { name:'Combustion Reaction', steps:[
    { lbl:'üîµ Load CH‚ÇÑ Gas', cls:'b',
      run(){
        setLiq('beaker_liq', 26, 'linear-gradient(rgba(100,180,255,.28),rgba(60,140,220,.55))');
        log('Methane (CH‚ÇÑ) loaded into combustion chamber.','h');
        log('Colourless gas ‚Äî not visible.','');
        S.gas=true; rb();
      }
    },
    { lbl:'üî• Ignite', cls:'o', req:'gas',
      run(){
        flameOn(true); doFlash('flask_flash');
        setLiq('flask_liq', 28, 'linear-gradient(rgba(255,220,50,.38),rgba(255,180,20,.68))');
        log('Spark applied! Combustion initiated.','rx');
        log('CH‚ÇÑ + 2O‚ÇÇ ‚Üí CO‚ÇÇ + 2H‚ÇÇO + heat','rx');
        log('Exothermic! Bright visible flame.','w');
        startBoiling();
        let t=25;
        const iv=setInterval(()=>{
          t=Math.min(860,t+22);
          setHead(`COMBUSTION | ${Math.round(t)}¬∞C`);
          if(t>=860){ clearInterval(iv); log('Peak flame temp: ~860¬∞C','w'); }
        },100);
        tmrs.push(iv);
        S.ignited=true; rb();
      }
    },
    { lbl:'üß™ Collect CO‚ÇÇ', cls:'g', req:'ignited',
      run(){
        setLiq('cyl_liq', 68, 'linear-gradient(rgba(180,200,175,.4),rgba(140,160,135,.7))');
        log('CO‚ÇÇ collected via downward displacement.','s');
        log('Reading: 250 mL CO‚ÇÇ collected.','s');
      }
    },
    { lbl:'üíß Test with Limewater', cls:'b', req:'ignited',
      run(){
        setLiq('ttl2', 65, 'linear-gradient(rgba(230,230,220,.5),rgba(200,200,180,.85))');
        log('CO‚ÇÇ + Ca(OH)‚ÇÇ ‚Üí CaCO‚ÇÉ‚Üì + H‚ÇÇO','rx');
        log('‚úÖ Milky white precipitate confirms CO‚ÇÇ!','s');
      }
    },
    { lbl:'‚Ü∫ Reset Lab', cls:'x', run(){ resetLab(); } }
  ]},

  /* 2 ‚îÄ Titration */
  { name:'Weak Acid Titration', steps:[
    { lbl:'üîµ Fill Burette (NaOH)', cls:'b',
      run(){
        setLiq('cyl_liq', 90, 'linear-gradient(rgba(0,150,255,.45),rgba(0,100,200,.82))');
        log('Burette filled with 0.1M NaOH solution.','h');
        S.burette=true; rb();
      }
    },
    { lbl:'üî¥ Add Acetic Acid 25mL', cls:'r', req:'burette',
      run(){
        setLiq('flask_liq', 40, 'linear-gradient(rgba(255,200,80,.55),rgba(220,150,20,.88))');
        setLiq('beaker_liq', 34, 'linear-gradient(rgba(255,200,80,.5),rgba(220,150,20,.82))');
        setPH(3.5);
        log('25 mL of 0.1M CH‚ÇÉCOOH added.','h');
        log('Weak acid, partial dissociation. pH = 3.5','');
        S.acid2=true; rb();
      }
    },
    { lbl:'üíú Add Indicator', cls:'p', req:'acid2',
      run(){
        setLiq('flask_liq', 40, 'linear-gradient(rgba(255,140,180,.55),rgba(220,60,100,.88))');
        log('Phenolphthalein added (colourless in acid).','rx');
        S.indic=true; rb();
      }
    },
    { lbl:'‚ûï Run Titration (live)', cls:'b', req:'acid2',
      run(){
        log('Dripping NaOH from burette...','h');
        let vol=0;
        const iv=setInterval(()=>{
          vol+=0.5;
          const ph=Math.min(3.5+(vol/50)*9,11);
          setPH(ph);
          const cy=Math.max(8,90-(vol*1.6));
          setLiq('cyl_liq', cy, 'linear-gradient(rgba(0,150,255,.45),rgba(0,100,200,.82))');
          setHead(`pH: ${ph.toFixed(1)} | NaOH: ${vol.toFixed(1)} mL`);
          if(vol>=25){
            clearInterval(iv);
            doFlash('flask_flash');
            setLiq('flask_liq', 55, 'linear-gradient(rgba(255,100,200,.65),rgba(220,30,150,.92))');
            setLiq('beaker_liq', 54, 'linear-gradient(rgba(255,100,200,.55),rgba(200,20,130,.88))');
            setPH(8.7);
            log('‚úÖ Equivalence point! V = 25.0 mL NaOH','s');
            log('Pink colour appears ‚Üí endpoint!','s');
            log('CH‚ÇÉCOOH + NaOH ‚Üí CH‚ÇÉCOONa + H‚ÇÇO','rx');
          }
        },180);
        tmrs.push(iv);
      }
    },
    { lbl:'‚Ü∫ Reset Lab', cls:'x', run(){ resetLab(); } }
  ]},

  /* 3 ‚îÄ Redox */
  { name:'Redox Reaction', steps:[
    { lbl:'üü£ Add KMnO‚ÇÑ', cls:'p',
      run(){
        setLiq('flask_liq', 40, 'linear-gradient(rgba(160,60,255,.65),rgba(100,10,200,.92))');
        setLiq('beaker_liq', 34, 'linear-gradient(rgba(160,60,255,.58),rgba(100,10,200,.88))');
        setLiq('ttl3', 55, 'linear-gradient(rgba(180,80,255,.65),rgba(120,20,220,.95))');
        setPH(1);
        log('KMnO‚ÇÑ (deep purple) added as oxidising agent.','rx');
        log('Acidified with H‚ÇÇSO‚ÇÑ. pH = 1','w');
        S.kmno4=true; rb();
      }
    },
    { lbl:'‚ö™ Add H‚ÇÇO‚ÇÇ (Reductant)', cls:'b', req:'kmno4',
      run(){
        log('Adding H‚ÇÇO‚ÇÇ dropwise...','h');
        let step=0;
        const iv=setInterval(()=>{
          step++;
          if(step===1){ log('Vigorous bubbling! O‚ÇÇ gas evolving.','rx'); startBoiling(); }
          if(step===3){
            setLiq('flask_liq', 50, 'linear-gradient(rgba(180,160,135,.55),rgba(120,98,72,.88))');
            setLiq('beaker_liq', 50, 'linear-gradient(rgba(180,160,135,.5),rgba(120,98,72,.82))');
            log('Purple fading ‚Üí brown MnO‚ÇÇ precipitate!','rx');
          }
          if(step===6){
            clearInterval(iv);
            doFlash('flask_flash');
            setLiq('flask_liq', 54, 'linear-gradient(rgba(200,175,138,.45),rgba(140,108,58,.88))');
            log('‚úÖ KMnO‚ÇÑ fully reduced to MnO‚ÇÇ.','s');
            log('2KMnO‚ÇÑ + 5H‚ÇÇO‚ÇÇ + 3H‚ÇÇSO‚ÇÑ ‚Üí 2MnSO‚ÇÑ + 5O‚ÇÇ‚Üë + 8H‚ÇÇO','rx');
            setPH(3);
          }
        },560);
        tmrs.push(iv);
        S.h2o2=true; rb();
      }
    },
    { lbl:'üå° Monitor Temperature', cls:'o', req:'kmno4',
      run(){
        log('Thermometer inserted...','h');
        let t=22;
        const iv=setInterval(()=>{
          t+=1.4;
          setHead(`REDOX | ${t.toFixed(1)}¬∞C`);
          if(t>=38){ clearInterval(iv); log(`Peak: ${t.toFixed(1)}¬∞C ‚Äî mildly exothermic.`,'w'); }
        },140);
        tmrs.push(iv);
      }
    },
    { lbl:'‚Ü∫ Reset Lab', cls:'x', run(){ resetLab(); } }
  ]}
];

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   UI CONTROL
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let curExp=0;

function rb(){
  const exp=EXPS[curExp];
  const area=document.getElementById('btns');
  area.innerHTML='';
  exp.steps.forEach(step=>{
    const b=document.createElement('button');
    b.className='lbtn '+step.cls;
    b.textContent=step.lbl;
    if(step.req && !S[step.req]) b.disabled=true;
    b.onclick=()=>step.run();
    area.appendChild(b);
  });
}

function selExp(idx, el){
  document.querySelectorAll('.eopt').forEach(e=>e.classList.remove('act'));
  el.classList.add('act');
  curExp=idx;
  resetLab(false);
  log(`--- ${EXPS[idx].name} ---`,'h');
  rb();
}

function resetLab(addLog=true){
  clearTmrs();
  S={};
  setLiq('flask_liq',0);
  setLiq('beaker_liq',0);
  setLiq('cyl_liq',38,'linear-gradient(rgba(0,150,255,.42),rgba(0,100,200,.78))');
  ['ttl0','ttl1','ttl2','ttl3'].forEach((id,i)=>{
    const bgs=['linear-gradient(rgba(255,80,80,.5),rgba(200,30,30,.9))','linear-gradient(rgba(80,180,255,.5),rgba(0,130,220,.9))','linear-gradient(rgba(80,220,130,.5),rgba(0,170,80,.9))','linear-gradient(rgba(200,140,255,.5),rgba(140,50,220,.9))'];
    const hs=[42,54,37,50];
    setLiq(id, hs[i], bgs[i]);
  });
  flameOn(false);
  stopBoiling();
  setPH(null);
  if(addLog) log('Lab reset. Ready.','');
  rb();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INIT & RESIZE
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
window.addEventListener('resize', ()=>{
  resizeCanvas();
  setTimeout(positionFlame, 100);
});

// Initial render
resizeCanvas();
setTimeout(positionFlame, 200);

log(`--- ${EXPS[0].name} ---`,'h');
log('Click a control step to begin the experiment.','');
setPH(null);
rb();
</script>
</body>
</html>
