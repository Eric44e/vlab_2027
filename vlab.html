
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3D Chemistry Lab - Advanced Simulation</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;overflow:hidden;background:#0a0e1a;font-family:'Courier New',monospace;}

#app{display:flex;flex-direction:column;width:100%;height:100%;}

/* Top Bar with animated gradient */
#topbar{
  height:44px;min-height:44px;
  background:linear-gradient(90deg,#070c18,#0d1526,#1a2a3a,#0d1526,#070c18);
  background-size:400% 100%;
  animation:gradientMove 8s ease infinite;
  border-bottom:1px solid rgba(0,210,255,.3);
  display:flex;align-items:center;justify-content:space-between;
  padding:0 20px;flex-shrink:0;
  position:relative;
  overflow:hidden;
}

@keyframes gradientMove {
  0%{background-position:0% 50%;}
  50%{background-position:100% 50%;}
  100%{background-position:0% 50%;}
}

#topbar::after{
  content:'';
  position:absolute;
  top:0;left:-100%;width:50%;height:100%;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,0.1),transparent);
  animation:shimmer 3s infinite;
}

@keyframes shimmer{
  0%{left:-100%;}
  20%{left:120%;}
  100%{left:120%;}
}

#topbar .logo{font-size:18px;font-weight:900;color:#00d4ff;letter-spacing:3px;text-shadow:0 0 20px rgba(0,212,255,.8);animation:pulse 2s infinite;}
@keyframes pulse{0%{opacity:1;}50%{opacity:0.8;text-shadow:0 0 30px rgba(0,212,255,1);}100%{opacity:1;}}
#phdisp{font-size:11px;padding:4px 16px;border:1px solid rgba(0,212,255,.3);border-radius:20px;color:#00d4ff;background:rgba(0,212,255,.05);transition:all .6s;white-space:nowrap;min-width:130px;text-align:center;position:relative;overflow:hidden;}
#phdisp::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:conic-gradient(transparent,rgba(0,212,255,0.3),transparent);animation:rotate 4s linear infinite;opacity:0.5;}
@keyframes rotate{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}

#body{display:flex;flex:1;overflow:hidden;min-height:0;}

/* Lab Canvas Area with floating particles */
#labwrap{
  flex:1;position:relative;overflow:hidden;
  background:linear-gradient(180deg,#8fa5c0 0%,#a8bdd4 45%,#6a7a95 45%,#4e5e78 100%);
  animation:ambientLight 10s ease infinite;
}

@keyframes ambientLight{
  0%,100%{filter:brightness(1);}
  50%{filter:brightness(1.05);}
}

/* Floating particles */
#particles{
  position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;
  z-index:1;
}
.particle{
  position:absolute;
  background:rgba(255,255,255,0.3);
  border-radius:50%;
  pointer-events:none;
  animation:floatParticle 15s linear infinite;
}
@keyframes floatParticle{
  0%{transform:translateY(100vh) translateX(0) scale(0.5);opacity:0;}
  10%{opacity:0.6;}
  90%{opacity:0.4;}
  100%{transform:translateY(-20vh) translateX(50px) scale(1.5);opacity:0;}
}

/* Canvas for 3D room rendering */
#bgcanvas{position:absolute;top:0;left:0;width:100%;height:100%;display:block;z-index:2;}

/* Equipment overlay */
#overlay{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:3;}

/* Equipment items */
.eitem{position:absolute;pointer-events:all;transition:transform 0.5s cubic-bezier(0.34,1.56,0.64,1);animation:appear 0.6s ease-out;}
@keyframes appear{
  from{opacity:0;transform:translateY(30px) scale(0.8);}
  to{opacity:1;transform:translateY(0) scale(1);}
}
.eitem:hover{transform:translateY(-5px) scale(1.02);z-index:10;}

/* Glassware Styles with enhanced animations */
.glass-container{
  position:relative;
  border-radius:inherit;
  overflow:hidden;
  cursor:pointer;
  transition:filter .2s, transform .3s, box-shadow .3s;
  box-shadow:0 10px 20px rgba(0,0,0,0.3);
  animation:glassPulse 4s ease-in-out infinite;
}
@keyframes glassPulse{
  0%,100%{box-shadow:0 10px 20px rgba(0,0,0,0.3), inset -5px -5px 15px rgba(255,255,255,0.1);}
  50%{box-shadow:0 15px 25px rgba(0,212,255,0.2), inset -8px -8px 20px rgba(255,255,255,0.15);}
}
.glass-container:hover{
  filter:brightness(1.15);
  transform:scale(1.03);
  box-shadow:0 15px 30px rgba(0,212,255,0.3);
}

.liquid{
  position:absolute;bottom:0;left:0;right:0;
  transition:height 1.2s cubic-bezier(.34,1.56,.64,1), background-color 1.5s ease, background 1.5s ease;
  border-radius:0 0 inherit inherit;
  animation:liquidWave 5s ease-in-out infinite;
}
@keyframes liquidWave{
  0%,100%{transform:scaleY(1);}
  50%{transform:scaleY(1.02);}
}

/* Bubble Animation */
.bubble-layer{position:absolute;inset:0;pointer-events:none;overflow:hidden;}
.bubble{
  position:absolute;border-radius:50%;
  background:rgba(255,255,255,0.6);
  animation:bubbleRise 2s ease-out forwards;
  pointer-events:none;
}
@keyframes bubbleRise{
  0%{opacity:0.8;transform:translateY(0) scale(0.5);}
  50%{opacity:0.6;transform:translateY(-25px) scale(1);}
  100%{opacity:0;transform:translateY(-60px) scale(0.8);}
}

/* Steam Particles */
.steam-particle{
  position:absolute;border-radius:50%;
  background:rgba(255,255,255,0.4);
  animation:steamRise 3s ease-out forwards;
  pointer-events:none;
}
@keyframes steamRise{
  0%{opacity:0.7;transform:translateY(0) translateX(0) scale(0.5);}
  50%{opacity:0.4;transform:translateY(-40px) translateX(var(--dx,10px)) scale(1.2);}
  100%{opacity:0;transform:translateY(-90px) translateX(var(--dx,20px)) scale(1.8);}
}

/* Flame Animation */
#flame-el{
  position:absolute;
  width:24px;height:50px;
  background:radial-gradient(ellipse at 50% 100%,#fff 0%,#ffe066 14%,#ff9500 44%,#ff3300 80%,transparent 100%);
  border-radius:50% 50% 28% 28%;
  animation:flameFlicker .08s infinite alternate, flameGlow 2s infinite;
  transform-origin:bottom center;
  opacity:0;
  transition:opacity .4s;
  pointer-events:none;
  filter:blur(2px);
  z-index:5;
}
@keyframes flameFlicker{
  from{transform:scaleX(1) scaleY(1) rotate(-2deg);filter:blur(2px);}
  to{transform:scaleX(.88) scaleY(1.1) rotate(2deg);filter:blur(1px);}
}
@keyframes flameGlow{
  0%,100%{box-shadow:0 0 30px rgba(255,150,0,0.8);}
  50%{box-shadow:0 0 50px rgba(255,100,0,1);}
}

/* Smoke Effect */
.smoke-particle{
  position:absolute;border-radius:50%;
  background:rgba(150,150,150,0.3);
  animation:smokeRise 4s ease-out forwards;
  pointer-events:none;
}
@keyframes smokeRise{
  0%{opacity:0.5;transform:translateY(0) scale(0.3);}
  50%{opacity:0.3;transform:translateY(-50px) scale(1.5);}
  100%{opacity:0;transform:translateY(-120px) scale(2.5);}
}

/* Glass Shine Animation */
.glass-shine{
  position:absolute;top:8px;left:6px;
  width:5px;border-radius:50%;
  background:rgba(255,255,255,.45);
  pointer-events:none;
  animation:shineMove 3s ease-in-out infinite;
}
@keyframes shineMove{
  0%,100%{transform:translateX(0);opacity:0.45;}
  50%{transform:translateX(10px);opacity:0.8;}
}

/* Flash Effect */
.flash-over{
  position:absolute;inset:0;background:transparent;
  pointer-events:none;transition:background .15s;
  border-radius:inherit;
  z-index:10;
}
@keyframes flash{
  0%{background:rgba(255,255,255,0.8);}
  100%{background:transparent;}
}

/* Sidebar with glass morphism */
#sidebar{
  width:280px;min-width:280px;
  background:linear-gradient(180deg,#060b15ee,#09101eee);
  border-left:1px solid rgba(0,210,255,.2);
  display:flex;flex-direction:column;
  overflow:hidden;
  backdrop-filter:blur(10px);
  position:relative;
  z-index:10;
}
#sidebar::before{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,transparent,#00d4ff,transparent);
  animation:sidebarGlow 3s linear infinite;
}
@keyframes sidebarGlow{
  0%{transform:translateX(-100%);}
  100%{transform:translateX(100%);}
}

/* Experiment options with hover effects */
.eopt{
  padding:8px 10px;margin-bottom:5px;
  border:1px solid #162030;border-radius:6px;
  cursor:pointer;font-size:10px;color:#4a6a8a;
  transition:all .3s;line-height:1.5;
  position:relative;overflow:hidden;
}
.eopt::before{
  content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
  background:linear-gradient(90deg,transparent,rgba(0,212,255,0.2),transparent);
  transition:left 0.5s;
}
.eopt:hover::before{left:100%;}
.eopt:hover{border-color:rgba(0,212,255,.35);color:#88aabb;background:rgba(0,212,255,.04);transform:translateX(5px);}
.eopt.act{border-color:#00d4ff;color:#00d4ff;background:rgba(0,212,255,.07);animation:pulseBorder 2s infinite;}
@keyframes pulseBorder{
  0%,100%{box-shadow:0 0 5px rgba(0,212,255,0.3);}
  50%{box-shadow:0 0 15px rgba(0,212,255,0.7);}
}

/* Control buttons with animations */
.lbtn{
  display:block;width:100%;padding:9px 12px;margin-bottom:6px;
  border-radius:6px;border:1px solid;background:transparent;
  font-family:'Courier New',monospace;font-size:11px;letter-spacing:.8px;
  cursor:pointer;transition:all .3s;text-transform:uppercase;text-align:left;
  position:relative;overflow:hidden;
}
.lbtn:disabled{opacity:.25;cursor:not-allowed;animation:none;}
.lbtn::after{
  content:'';position:absolute;top:50%;left:50%;width:0;height:0;
  border-radius:50%;background:rgba(255,255,255,0.3);
  transform:translate(-50%,-50%);
  transition:width 0.3s, height 0.3s;
}
.lbtn:hover:not(:disabled)::after{
  width:200px;height:200px;
}
.lbtn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 5px 15px currentColor;}

/* pH bar with glow */
#phbar-track{
  height:13px;border-radius:6px;
  background:linear-gradient(90deg,#ff2244,#ff8800,#eeee00,#33dd66,#0088ff,#8800cc);
  position:relative;border:1px solid #1a2a3a;overflow:visible;
  animation:rainbowWave 10s linear infinite;
  background-size:200% 100%;
}
@keyframes rainbowWave{
  0%{background-position:0% 50%;}
  100%{background-position:200% 50%;}
}
#phneedle{
  position:absolute;top:-5px;width:3px;height:23px;
  background:#fff;border-radius:2px;
  box-shadow:0 0 15px rgba(255,255,255,.9);
  transition:left 1s cubic-bezier(0.34,1.56,0.64,1);
  left:50%;transform:translateX(-50%);
  animation:needlePulse 1s infinite alternate;
}
@keyframes needlePulse{
  from{box-shadow:0 0 10px rgba(255,255,255,0.8);}
  to{box-shadow:0 0 20px rgba(255,255,255,1);}
}

/* Log entries animation */
.le{
  font-size:10px;line-height:1.6;padding:4px 8px;margin-bottom:3px;
  border-left:2px solid #162030;color:#3a5568;
  animation:logEntry .3s ease-out;
  transform-origin:left;
}
@keyframes logEntry{
  from{opacity:0;transform:translateX(-10px) scaleX(0.9);}
  to{opacity:1;transform:translateX(0) scaleX(1);}
}
.le.h{border-left-color:#00d4ff;color:#7aaacc;animation:glowBlue 2s infinite;}
.le.w{border-left-color:#ff9500;color:#bb7700;}
.le.s{border-left-color:#33ee88;color:#18994a;}
.le.rx{border-left-color:#c077ff;color:#9944cc;}

@keyframes glowBlue{
  0%,100%{text-shadow:0 0 2px #00d4ff;}
  50%{text-shadow:0 0 8px #00d4ff;}
}

/* Molecular viewer (new feature) */
#molecule-viewer{
  position:fixed;bottom:20px;right:20px;width:150px;height:150px;
  background:rgba(10,20,30,0.8);border-radius:10px;
  border:1px solid #00d4ff;backdrop-filter:blur(5px);
  display:none;flex-direction:column;z-index:100;
}
.molecule-atom{
  position:absolute;border-radius:50%;
  transition:all 0.5s;
}
@keyframes orbit{
  from{transform:rotate(0deg) translateX(30px) rotate(0deg);}
  to{transform:rotate(360deg) translateX(30px) rotate(-360deg);}
}
</style>
</head>
<body>
<div id="app">
  <div id="topbar">
    <div class="logo">âš— 3D CHEMISTRY LAB</div>
    <div class="ver">ADVANCED SIMULATION v4.0</div>
    <div id="phdisp">pH: â€”</div>
  </div>

  <div id="body">
    <div id="labwrap">
      <div id="particles"></div>
      <canvas id="bgcanvas"></canvas>
      <div id="overlay">
        <div id="flame-el"></div>
        <div id="steam-container"></div>
        <div id="smoke-container"></div>
      </div>
    </div>

    <div id="sidebar">
      <div id="expsel">
        <h3 style="color:#00d4ff;letter-spacing:2px;margin-bottom:12px;font-size:11px;">â–¸ SELECT EXPERIMENT</h3>
        <div class="eopt act" onclick="selExp(0,this)">
          <span style="color:#ff4466;">ðŸ”¥</span> Acid-Base Neutralisation<br>
          <span style="color:#1e3248;font-size:9px">HCl + NaOH â†’ NaCl + Hâ‚‚O</span>
        </div>
        <div class="eopt" onclick="selExp(1,this)">
          <span style="color:#ffaa00;">âš¡</span> Combustion Reaction<br>
          <span style="color:#1e3248;font-size:9px">CHâ‚„ + 2Oâ‚‚ â†’ COâ‚‚ + 2Hâ‚‚O</span>
        </div>
        <div class="eopt" onclick="selExp(2,this)">
          <span style="color:#33ee88;">ðŸ§ª</span> Acid-Base Titration<br>
          <span style="color:#1e3248;font-size:9px">CHâ‚ƒCOOH + NaOH â†’ Salt</span>
        </div>
        <div class="eopt" onclick="selExp(3,this)">
          <span style="color:#c077ff;">âœ¨</span> Redox Reaction<br>
          <span style="color:#1e3248;font-size:9px">KMnOâ‚„ + Hâ‚‚Oâ‚‚ â†’ MnOâ‚‚</span>
        </div>
      </div>

      <div id="ctrl">
        <h3 style="color:#00d4ff;letter-spacing:2px;margin-bottom:12px;font-size:11px;">â–¸ CONTROLS</h3>
        <div id="btns"></div>
      </div>

      <div id="phbar-wrap" style="margin:15px 12px;">
        <div id="phbar-track"><div id="phneedle"></div></div>
        <div id="phlabels" style="display:flex;justify-content:space-between;padding:2px 0;font-size:9px;color:#3a5a7a;">
          <span>0</span><span>3</span><span>7</span><span>10</span><span>14</span>
        </div>
      </div>

      <div id="logwrap" style="flex:1;overflow-y:auto;padding:10px 12px;min-height:0;">
        <h3 style="color:#00d4ff;letter-spacing:2px;margin-bottom:12px;font-size:11px;">â–¸ LAB JOURNAL</h3>
        <div id="loglist"></div>
      </div>
    </div>
  </div>
</div>

<!-- Molecular Viewer (hidden initially) -->
<div id="molecule-viewer"></div>

<script>
/* =============================================
   3D CANVAS ROOM RENDERER WITH ENHANCED EFFECTS
   ============================================= */
const canvas = document.getElementById('bgcanvas');
const ctx = canvas.getContext('2d');
let particles = [];

// Particle system for floating dust
function initParticles() {
  const particleContainer = document.getElementById('particles');
  for(let i = 0; i < 50; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    p.style.left = Math.random() * 100 + '%';
    p.style.width = p.style.height = (1 + Math.random() * 3) + 'px';
    p.style.animationDelay = Math.random() * 5 + 's';
    p.style.animationDuration = (8 + Math.random() * 10) + 's';
    particleContainer.appendChild(p);
  }
}
initParticles();

function resizeCanvas(){
  const wrap = document.getElementById('labwrap');
  canvas.width = wrap.clientWidth;
  canvas.height = wrap.clientHeight;
  drawRoom();
  positionEquipment();
}

function drawRoom(){
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);

  // Animated horizon with slight movement
  const time = Date.now() / 1000;
  const hor = H * 0.62 + Math.sin(time * 0.2) * 3;
  const vpx = W * 0.5 + Math.sin(time * 0.1) * 5;
  const vpy = H * 0.2;

  /* BACK WALL with animated gradient */
  const wallGrad = ctx.createLinearGradient(0, 0, 0, hor);
  wallGrad.addColorStop(0, '#b8cfe0');
  wallGrad.addColorStop(0.5 + Math.sin(time * 0.3) * 0.05, '#cddaec');
  wallGrad.addColorStop(1, '#aabbd0');
  ctx.fillStyle = wallGrad;
  ctx.fillRect(0, 0, W, hor);

  // Animated wall grid lines
  ctx.strokeStyle = 'rgba(0,0,0,0.05)';
  ctx.lineWidth = 1;
  for(let x=0; x<W; x+=80 + Math.sin(time + x) * 10){ 
    ctx.beginPath();
    ctx.moveTo(x,0);
    ctx.lineTo(x + Math.sin(time) * 20, hor);
    ctx.stroke(); 
  }
  for(let y=0; y<hor; y+=70 + Math.sin(time + y) * 10){ 
    ctx.beginPath();
    ctx.moveTo(0,y);
    ctx.lineTo(W, y + Math.cos(time) * 20);
    ctx.stroke(); 
  }

  /* LEFT SIDE WALL with parallax */
  ctx.beginPath();
  ctx.moveTo(0, 0);
  ctx.lineTo(W*0.08 + Math.sin(time) * 5, vpy);
  ctx.lineTo(W*0.08 + Math.cos(time) * 5, hor);
  ctx.lineTo(0, hor);
  ctx.closePath();
  const lwGrad = ctx.createLinearGradient(0,0,W*0.08,0);
  lwGrad.addColorStop(0,'#8898b8'); lwGrad.addColorStop(1,'#aabbd0');
  ctx.fillStyle = lwGrad; ctx.fill();

  /* RIGHT SIDE WALL */
  ctx.beginPath();
  ctx.moveTo(W, 0);
  ctx.lineTo(W*0.92 + Math.sin(time) * 5, vpy);
  ctx.lineTo(W*0.92 + Math.cos(time) * 5, hor);
  ctx.lineTo(W, hor);
  ctx.closePath();
  const rwGrad = ctx.createLinearGradient(W,0,W*0.92,0);
  rwGrad.addColorStop(0,'#8898b8'); rwGrad.addColorStop(1,'#aabbd0');
  ctx.fillStyle = rwGrad; ctx.fill();

  /* FLOOR with animated tiles */
  ctx.beginPath();
  ctx.moveTo(0, hor); ctx.lineTo(W, hor); ctx.lineTo(W, H); ctx.lineTo(0, H);
  ctx.closePath();
  const flGrad = ctx.createLinearGradient(0, hor, 0, H);
  flGrad.addColorStop(0,'#6a7a96'); flGrad.addColorStop(1,'#46566e');
  ctx.fillStyle = flGrad; ctx.fill();

  // Animated floor tiles
  ctx.strokeStyle = 'rgba(255,255,255,0.1)';
  ctx.lineWidth = 1;
  for(let i=1; i<=6; i++){
    const y = hor + (H-hor)*i/6 + Math.sin(time + i) * 5;
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke();
  }
  for(let x=0; x<=W; x+=W/8){
    ctx.beginPath(); ctx.moveTo(vpx + Math.sin(time) * 20, hor); ctx.lineTo(x + Math.cos(time) * 10, H); ctx.stroke();
  }

  /* CEILING LIGHT with pulsing effect */
  const lightX = W/2, lightW = W*0.28;
  const pulseIntensity = 0.8 + Math.sin(time * 3) * 0.2;
  ctx.fillStyle = `rgba(255,255,255,${pulseIntensity})`;
  ctx.fillRect(lightX - lightW/2, 0, lightW, 8);
  
  const glowGrad = ctx.createRadialGradient(lightX,4,0,lightX,4,lightW/2);
  glowGrad.addColorStop(0,`rgba(210,235,255,${0.4 + Math.sin(time)*0.1})`);
  glowGrad.addColorStop(1,'rgba(210,235,255,0)');
  ctx.fillStyle = glowGrad;
  ctx.ellipse(lightX, 4, lightW/2, 80, 0, 0, Math.PI*2);
  ctx.fill();

  /* BLACKBOARD with animated text */
  const bbx = W*0.04, bby = H*0.03, bbw = W*0.24, bbh = H*0.35;
  ctx.fillStyle = '#1a2e18';
  roundRect(ctx, bbx, bby, bbw, bbh, 5);
  ctx.fill();
  ctx.strokeStyle = '#3d2e14'; ctx.lineWidth = 9;
  roundRect(ctx, bbx, bby, bbw, bbh, 5);
  ctx.stroke();

  // Animated blackboard text
  ctx.fillStyle = 'rgba(215,225,195,0.72)';
  ctx.font = '12px Courier New';
  ctx.fillText('HCl + NaOH â†’', bbx+14, bby+30);
  ctx.fillStyle = `rgba(255,230,80,${0.7 + Math.sin(time)*0.2})`;
  ctx.fillText('  NaCl + Hâ‚‚O', bbx+14, bby+52);
  ctx.fillStyle = 'rgba(215,225,195,0.55)';
  ctx.fillText('Neutralisation', bbx+14, bby+72);
  ctx.fillText('Î”H = âˆ’57.3 kJ/mol', bbx+14, bby+94);
  ctx.fillStyle = `rgba(255,230,80,${0.7 + Math.sin(time*2)*0.2})`;
  ctx.fillText('âš¡ pH: ' + (window.currentPH ? window.currentPH.toFixed(1) : '7.0'), bbx+14, bby+118);

  /* WINDOW with animated light */
  const wx = W*0.72, wy = H*0.04, ww = W*0.2, wh = H*0.33;
  const winGrad = ctx.createLinearGradient(wx,wy,wx+ww,wy+wh);
  winGrad.addColorStop(0,`rgba(160,200,255,${0.8 + Math.sin(time)*0.2})`);
  winGrad.addColorStop(1,`rgba(200,224,255,${0.7 + Math.cos(time)*0.2})`);
  ctx.fillStyle = winGrad;
  roundRect(ctx,wx,wy,ww,wh,3); ctx.fill();
  
  ctx.shadowColor = `rgba(120,180,255,${0.3 + Math.sin(time)*0.2})`; ctx.shadowBlur = 30;
  ctx.strokeStyle = '#3a4a68'; ctx.lineWidth = 10;
  roundRect(ctx,wx,wy,ww,wh,3); ctx.stroke();
  ctx.shadowBlur = 0;

  // Animated window panes
  ctx.strokeStyle = '#3a4a68'; ctx.lineWidth = 4;
  ctx.beginPath();ctx.moveTo(wx,wy+wh/2 + Math.sin(time)*3);ctx.lineTo(wx+ww,wy+wh/2 + Math.cos(time)*3);ctx.stroke();
  ctx.beginPath();ctx.moveTo(wx+ww/2 + Math.cos(time)*3,wy);ctx.lineTo(wx+ww/2 + Math.sin(time)*3,wy+wh);ctx.stroke();

  // Store bench geometry
  window.benchGeo = {
    x: W*0.05, y: hor, w: W*0.9,
    surfaceY: hor
  };
}

function roundRect(ctx, x, y, w, h, r){
  ctx.beginPath();
  ctx.moveTo(x+r, y);
  ctx.lineTo(x+w-r, y); ctx.arcTo(x+w,y,x+w,y+r,r);
  ctx.lineTo(x+w, y+h-r); ctx.arcTo(x+w,y+h,x+w-r,y+h,r);
  ctx.lineTo(x+r, y+h); ctx.arcTo(x,y+h,x,y+h-r,r);
  ctx.lineTo(x, y+r); ctx.arcTo(x,y,x+r,y,r);
  ctx.closePath();
}

/* =============================================
   ENHANCED EQUIPMENT POSITIONING
   ============================================= */
function positionEquipment(){
  if(!window.benchGeo) return;
  const ov = document.getElementById('overlay');
  const {x, y, w} = window.benchGeo;

  ov.querySelectorAll('.eitem').forEach(e=>e.remove());

  const baseY = y;
  const positions = [
    {id:'stand_group',  lf:0.04, W:88,  H:220},
    {id:'bset_group',   lf:0.19, W:80,  H:180},
    {id:'cyl_group',    lf:0.32, W:36,  H:130},
    {id:'water_group',  lf:0.40, W:44,  H:125},
    {id:'alc_group',    lf:0.47, W:40,  H:118},
    {id:'rack_group',   lf:0.55, W:116, H:95},
    {id:'scope_group',  lf:0.73, W:72,  H:115},
  ];

  positions.forEach(p=>{
    const el = document.createElement('div');
    el.className = 'eitem';
    el.id = p.id;
    el.style.cssText = `left:${x + w*p.lf}px;top:${baseY - p.H}px;width:${p.W}px;height:${p.H}px;`;
    ov.appendChild(el);
  });

  buildEnhancedGlassware();
  positionFlame();
}

function buildEnhancedGlassware(){
  buildRetortStand();
  buildBurnerSet();
  buildCylinder();
  buildWaterBottle();
  buildAlcBottle();
  buildRack();
  buildMicroscope();
}

function buildRetortStand(){
  const g = document.getElementById('stand_group');
  if(!g) return;
  g.innerHTML = `
    <div style="position:absolute;bottom:0;left:35px;width:8px;height:100%;background:linear-gradient(90deg,#888,#aaa,#888);border-radius:4px;box-shadow:2px 0 7px rgba(0,0,0,.4);animation:standPulse 3s infinite;">
      <div style="position:absolute;right:-27px;top:65px;width:25px;height:10px;background:linear-gradient(180deg,#888,#555);border-radius:3px;"></div>
      <div style="position:absolute;right:-44px;top:57px;width:30px;height:25px;border:3px solid #888;border-radius:50%;animation:clampRotate 4s infinite;"></div>
    </div>
    <div style="position:absolute;bottom:0;left:0;right:0;height:11px;background:linear-gradient(180deg,#888,#444);border-radius:3px;box-shadow:0 4px 9px rgba(0,0,0,.5);"></div>
    <div id="flask_wrap" style="position:absolute;left:34px;bottom:78px;">
      <div class="flask-neck"></div>
      <div id="flask_body" class="flask-body glass-container" style="width:60px;height:64px;position:relative;overflow:hidden;">
        <div id="flask_liq" class="liquid" style="height:0%;background:linear-gradient(rgba(255,80,50,.65),rgba(200,30,10,.92));border-radius:0 0 40% 40%;"></div>
        <div class="glass-shine" style="height:18px;"></div>
        <div id="flask_flash" class="flash-over"></div>
        <div class="bubble-layer" id="flask_bubbles"></div>
      </div>
    </div>
    <div class="ilabel">Erlenmeyer</div>
  `;
}

function buildBurnerSet(){
  const g = document.getElementById('bset_group');
  if(!g) return;
  g.innerHTML = `
    <div style="position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:34px;height:9px;background:linear-gradient(180deg,#555,#222);border-radius:3px;box-shadow:0 3px 7px rgba(0,0,0,.5);"></div>
    <div style="position:absolute;bottom:9px;left:50%;transform:translateX(-50%);width:14px;height:28px;background:linear-gradient(90deg,#555,#888,#555);border-radius:3px 3px 0 0;position:relative;"></div>
    <div style="position:absolute;bottom:37px;left:50%;transform:translateX(-50%);width:60px;height:38px;">
      <div style="position:absolute;bottom:0;left:5px;width:3px;height:36px;background:#666;border-radius:2px;transform:rotate(13deg);transform-origin:bottom;animation:rodVibrate 0.2s infinite alternate;"></div>
      <div style="position:absolute;bottom:0;right:5px;width:3px;height:36px;background:#666;border-radius:2px;transform:rotate(-13deg);transform-origin:bottom;animation:rodVibrate 0.2s infinite alternate-reverse;"></div>
    </div>
    <div id="beaker_wrap" style="position:absolute;bottom:75px;left:50%;transform:translateX(-50%);width:56px;">
      <div id="beaker_el" class="beaker-outer glass-container" style="width:56px;height:64px;position:relative;overflow:hidden;">
        <div class="beaker-lip"></div>
        <div class="glass-shine" style="height:17px;"></div>
        <div id="beaker_liq" class="liquid" style="height:0%;background:linear-gradient(rgba(0,180,120,.55),rgba(0,140,80,.9));border-radius:0 0 8px 8px;"></div>
        <div id="beaker_bub" class="bubble-layer"></div>
      </div>
    </div>
    <div class="ilabel" style="bottom:-18px;left:38px;">Beaker</div>
    <div id="steam_here" style="position:absolute;bottom:60px;left:10px;width:60px;height:80px;pointer-events:none;overflow:visible;"></div>
  `;
}

function buildCylinder(){
  const g = document.getElementById('cyl_group');
  if(!g) return;
  g.innerHTML = `
    <div style="width:26px;height:108px;margin:0 auto;background:rgba(180,220,255,.16);border:2px solid rgba(140,190,255,.4);border-radius:3px 3px 8px 8px;position:relative;overflow:hidden;box-shadow:inset -3px 0 8px rgba(0,80,200,.1);">
      <div id="cyl_liq" class="liquid" style="height:38%;background:linear-gradient(rgba(0,150,255,.42),rgba(0,100,200,.78));border-radius:0 0 6px 6px;"></div>
      <div style="position:absolute;top:0;left:0;right:0;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.1),transparent);animation:cylinderShine 3s infinite;"></div>
    </div>
    <div style="width:38px;height:7px;background:rgba(120,180,255,.25);border:1px solid rgba(120,180,255,.35);border-radius:3px;margin-left:-6px;"></div>
    <div class="ilabel">Cylinder</div>
  `;
}

function buildWaterBottle(){
  const g = document.getElementById('water_group');
  if(!g) return;
  g.innerHTML = `
    <div style="width:16px;height:10px;background:linear-gradient(#1a88cc,#0a5588);border-radius:3px 3px 0 0;margin:0 auto;animation:bottleCap 2s infinite;"></div>
    <div style="width:13px;height:22px;background:rgba(180,220,255,.26);border:2px solid rgba(140,190,255,.38);border-radius:2px 2px 0 0;margin:0 auto;"></div>
    <div class="bottle-body" style="width:44px;height:94px;position:relative;overflow:hidden;">
      <div class="liquid" style="position:absolute;bottom:0;width:100%;height:70%;background:linear-gradient(rgba(150,210,255,.35),rgba(80,160,240,.7));border-radius:0 0 5px 5px;"></div>
      <div class="bottle-label" style="background:rgba(255,255,255,.9);color:#0a3060;">Hâ‚‚O</div>
    </div>
    <div class="ilabel">Water</div>
  `;
}

function buildAlcBottle(){
  const g = document.getElementById('alc_group');
  if(!g) return;
  g.innerHTML = `
    <div style="width:15px;height:10px;background:linear-gradient(#883300,#551100);border-radius:3px 3px 0 0;margin:0 auto;"></div>
    <div style="width:12px;height:20px;background:rgba(255,220,120,.22);border:2px solid rgba(220,180,80,.38);border-radius:2px 2px 0 0;margin:0 auto;"></div>
    <div style="width:40px;height:88px;background:rgba(255,220,120,.16);border:2px solid rgba(220,180,80,.38);border-radius:5px 5px 7px 7px;position:relative;overflow:hidden;box-shadow:inset -4px 0 10px rgba(180,120,0,.08),3px 3px 12px rgba(0,0,0,.28);">
      <div class="liquid" style="position:absolute;bottom:0;width:100%;height:56%;background:linear-gradient(rgba(255,200,50,.28),rgba(200,140,0,.62));border-radius:0 0 5px 5px;"></div>
      <div class="bottle-label" style="color:#441100;background:rgba(255,240,190,.9)">EtOH</div>
    </div>
    <div class="ilabel">Alcohol</div>
  `;
}

function buildRack(){
  const g = document.getElementById('rack_group');
  if(!g) return;
  g.innerHTML = `
    <div style="width:115px;height:12px;background:linear-gradient(180deg,#777,#444);border-radius:4px;box-shadow:0 3px 7px rgba(0,0,0,.4);position:relative;z-index:2;">
      ${[0,1,2,3].map(i=>`
        <div id="tt${i}" class="test-tube" style="position:absolute;bottom:10px;left:${8+i*28}px;width:16px;height:70px;animation:tubeWobble ${2+i*0.2}s infinite alternate;">
          <div id="ttl${i}" class="liquid" style="height:${[42,54,37,50][i]}%;background:${['linear-gradient(rgba(255,80,80,.5),rgba(200,30,30,.9))','linear-gradient(rgba(80,180,255,.5),rgba(0,130,220,.9))','linear-gradient(rgba(80,220,130,.5),rgba(0,170,80,.9))','linear-gradient(rgba(200,140,255,.5),rgba(140,50,220,.9))'][i]};border-radius:0 0 10px 10px;"></div>
        </div>
      `).join('')}
    </div>
    <div style="width:97px;height:13px;background:linear-gradient(180deg,#555,#333);border-radius:0 0 4px 4px;margin:0 auto;"></div>
    <div class="ilabel" style="left:50%">Test Tubes</div>
  `;
}

function buildMicroscope(){
  const g = document.getElementById('scope_group');
  if(!g) return;
  g.innerHTML = `
    <div style="position:absolute;bottom:11px;left:30px;width:9px;height:88px;background:linear-gradient(90deg,#777,#999,#666);border-radius:4px;"></div>
    <div style="position:absolute;bottom:90px;left:8px;width:36px;height:17px;background:linear-gradient(180deg,#888,#555);border-radius:5px;transform:rotate(-10deg);"></div>
    <div style="position:absolute;bottom:103px;left:26px;width:10px;height:25px;background:linear-gradient(180deg,#999,#666);border-radius:4px;"></div>
    <div style="position:absolute;bottom:72px;left:31px;width:8px;height:19px;background:linear-gradient(180deg,#666,#333);border-radius:0 0 4px 4px;"></div>
    <div style="position:absolute;bottom:48px;left:12px;width:42px;height:6px;background:linear-gradient(180deg,#888,#555);border-radius:2px;"></div>
    <div style="position:absolute;bottom:0;left:0;right:0;height:11px;background:linear-gradient(180deg,#666,#333);border-radius:4px;box-shadow:0 4px 9px rgba(0,0,0,.5);"></div>
    <div class="ilabel">Microscope</div>
  `;
}

function positionFlame(){
  if(!window.benchGeo) return;
  const g = document.getElementById('bset_group');
  if(!g) return;
  const flame = document.getElementById('flame-el');
  const labRect = document.getElementById('labwrap').getBoundingClientRect();
  const bkEl = document.getElementById('beaker_wrap');
  if(!bkEl) return;
  const bkRect = bkEl.getBoundingClientRect();
  flame.style.cssText = `
    position:absolute;
    left:${bkRect.left - labRect.left + bkRect.width/2 - 12}px;
    top:${bkRect.top - labRect.top + bkRect.height + 14}px;
    width:24px;height:50px;
    opacity:0;
    z-index:4;
  `;
}

/* =============================================
   ENHANCED EFFECTS
   ============================================= */
function createBubbles(container, count = 3) {
  if(!container) return;
  for(let i = 0; i < count; i++) {
    const b = document.createElement('div');
    b.className = 'bubble';
    b.style.cssText = `
      left:${20 + Math.random() * 40}%;
      bottom:${Math.random() * 30}px;
      width:${3 + Math.random() * 6}px;
      height:${3 + Math.random() * 6}px;
      background:rgba(255,255,255,${0.5 + Math.random() * 0.4});
      animation:bubbleRise ${1 + Math.random() * 2}s ease-out forwards;
    `;
    container.appendChild(b);
    setTimeout(() => b.remove(), 3000);
  }
}

function createSteam(container, count = 2) {
  if(!container) return;
  for(let i = 0; i < count; i++) {
    const s = document.createElement('div');
    s.className = 'steam-particle';
    s.style.cssText = `
      left:${30 + Math.random() * 40}%;
      bottom:${40 + Math.random() * 30}px;
      width:${8 + Math.random() * 12}px;
      height:${8 + Math.random() * 12}px;
      --dx:${(Math.random() - 0.5) * 50}px;
      background:rgba(255,255,255,${0.2 + Math.random() * 0.3});
      animation:steamRise ${2 + Math.random() * 3}s ease-out forwards;
    `;
    container.appendChild(s);
    setTimeout(() => s.remove(), 4000);
  }
}

function createSmoke(container, count = 1) {
  if(!container) return;
  for(let i = 0; i < count; i++) {
    const s = document.createElement('div');
    s.className = 'smoke-particle';
    s.style.cssText = `
      left:${40 + Math.random() * 20}%;
      bottom:${50 + Math.random() * 20}px;
      width:${15 + Math.random() * 20}px;
      height:${15 + Math.random() * 20}px;
      background:rgba(100,100,100,${0.2 + Math.random() * 0.2});
      animation:smokeRise ${4 + Math.random() * 3}s ease-out forwards;
    `;
    container.appendChild(s);
    setTimeout(() => s.remove(), 5000);
  }
}

/* =============================================
   EXPERIMENT STATE MANAGEMENT
   ============================================= */
const tmrs = [];
let S = {};
let curExp = 0;
window.currentPH = null;

function setLiq(id, h, bg){
  const el = document.getElementById(id);
  if(!el) return;
  el.style.height = h + '%';
  if(bg) el.style.background = bg;
}

function doFlash(id){
  const el = document.getElementById(id);
  if(!el) return;
  el.style.background = 'rgba(255,255,255,.8)';
  setTimeout(()=>{ el.style.background='transparent'; }, 200);
  setTimeout(()=>{ el.style.background = 'rgba(255,255,255,.4)'; }, 50);
  setTimeout(()=>{ el.style.background='transparent'; }, 150);
}

function flameOn(on){
  const f = document.getElementById('flame-el');
  if(f) {
    f.style.opacity = on ? '1' : '0';
    if(on) {
      // Create periodic flame effects
      const interval = setInterval(() => {
        if(f.style.opacity === '1') {
          createSmoke(document.getElementById('smoke-container'), 1);
        }
      }, 500);
      tmrs.push(interval);
    }
  }
}

function startBoiling(){
  const iv = setInterval(()=>{
    const bb = document.getElementById('beaker_bub');
    if(bb) createBubbles(bb, 2);
    const sh = document.getElementById('steam_here');
    if(sh) createSteam(sh, 1);
  }, 300);
  tmrs.push(iv);
}

function stopBoiling(){
  const bb = document.getElementById('beaker_bub');
  const sh = document.getElementById('steam_here');
  const sm = document.getElementById('smoke-container');
  if(bb) bb.innerHTML = '';
  if(sh) sh.innerHTML = '';
  if(sm) sm.innerHTML = '';
}

function setPH(v){
  window.currentPH = v;
  const n = document.getElementById('phneedle');
  const d = document.getElementById('phdisp');
  if(v === null || v === undefined){
    n.style.left = '50%'; 
    d.textContent = 'pH: â€”';
    d.style.color = '#00d4ff'; 
    d.style.borderColor = 'rgba(0,212,255,.3)';
    return;
  }
  n.style.left = (v/14*100) + '%';
  d.textContent = `pH: ${(+v).toFixed(1)}`;
  const h = v<7 ? Math.round(v/7*55) : v===7 ? 120 : Math.round(120+(v-7)/7*220);
  d.style.color = `hsl(${h},80%,62%)`;
  d.style.borderColor = `hsla(${h},80%,55%,.45)`;
}

function log(msg, cls=''){
  const d = document.createElement('div');
  d.className = 'le' + (cls ? ' ' + cls : '');
  const ts = new Date().toLocaleTimeString('en', {hour12:false});
  d.textContent = `[${ts}] ${msg}`;
  const list = document.getElementById('loglist');
  list.prepend(d);
  while(list.children.length > 35) list.removeChild(list.lastChild);
}

function clearTmrs(){ 
  tmrs.forEach(t=>{try{clearInterval(t);}catch(e){}});  
  tmrs.length = 0; 
}

/* =============================================
   EXPERIMENTS DEFINITION
   ============================================= */
const EXPS = [
  { name:'Acid-Base Neutralisation', steps:[
    { lbl:'âž• Add HCl (Acid)', cls:'r',
      run(){
        setLiq('flask_liq', 44, 'linear-gradient(rgba(255,80,50,.65),rgba(200,30,10,.92))');
        setLiq('beaker_liq', 32, 'linear-gradient(rgba(255,140,80,.55),rgba(220,80,30,.88))');
        setLiq('cyl_liq', 54, 'linear-gradient(rgba(255,130,60,.5),rgba(210,60,20,.82))');
        setLiq('ttl0', 62, 'linear-gradient(rgba(255,60,60,.6),rgba(220,20,20,.95))');
        setPH(2);
        log('Added 20 mL HCl. Solution is strongly acidic.','h');
        log('Colour: pale yellow. pH = 2.0','');
        S.acid=true; rb();
        createBubbles(document.getElementById('beaker_bub'), 5);
      }
    },
    { lbl:'âž• Add NaOH (Base)', cls:'b', req:'acid',
      run(){
        doFlash('flask_flash');
        setLiq('flask_liq', 67, 'linear-gradient(rgba(0,220,160,.55),rgba(0,170,120,.92))');
        setLiq('beaker_liq', 54, 'linear-gradient(rgba(0,200,200,.52),rgba(0,150,180,.88))');
        setLiq('ttl1', 68, 'linear-gradient(rgba(0,210,255,.6),rgba(0,130,220,.95))');
        setPH(7);
        log('Added NaOH dropwise â€” neutralisation!','rx');
        log('NaCl + Hâ‚‚O formed. Î”H = âˆ’57.3 kJ/mol','rx');
        log('âœ… pH = 7.0 â€” equivalence point!','s');
        S.base=true; rb();
      }
    },
    { lbl:'ðŸ”¥ Heat Solution', cls:'o', req:'base',
      run(){
        flameOn(true);
        log('Heating started. Temperature rising...','h');
        let t=25;
        const iv=setInterval(()=>{
          t=Math.min(100,t+3);
          document.getElementById('phdisp').innerHTML = `pH: 7.0 | Temp: ${t}Â°C`;
          if(t>=100){ 
            clearInterval(iv); 
            startBoiling(); 
            log('Boiling! NaCl concentration increasing.','w');
          }
        },160);
        tmrs.push(iv);
      }
    },
    { lbl:'ðŸ’œ Add Indicator', cls:'p', req:'acid',
      run(){
        const h=S.base?67:44, bh=S.base?54:32;
        setLiq('flask_liq', h, 'linear-gradient(rgba(200,120,255,.58),rgba(140,20,220,.92))');
        setLiq('beaker_liq', bh, 'linear-gradient(rgba(200,120,255,.52),rgba(140,20,220,.88))');
        setLiq('ttl3', 62, 'linear-gradient(rgba(220,150,255,.6),rgba(150,20,220,.95))');
        log('Phenolphthalein added.','rx');
        log(S.base?'Neutral â†’ pale pink.':'Acidic â†’ colourless.','h');
      }
    },
    { lbl:'â†º Reset Lab', cls:'x', run(){ resetLab(); } }
  ]},
  { name:'Combustion Reaction', steps:[
    { lbl:'ðŸ”µ Load CHâ‚„ Gas', cls:'b',
      run(){
        setLiq('beaker_liq', 26, 'linear-gradient(rgba(100,180,255,.28),rgba(60,140,220,.55))');
        log('Methane (CHâ‚„) loaded into combustion chamber.','h');
        S.gas=true; rb();
      }
    },
    { lbl:'ðŸ”¥ Ignite', cls:'o', req:'gas',
      run(){
        flameOn(true); 
        doFlash('flask_flash');
        setLiq('flask_liq', 28, 'linear-gradient(rgba(255,220,50,.38),rgba(255,180,20,.68))');
        log('Spark applied! Combustion initiated.','rx');
        log('CHâ‚„ + 2Oâ‚‚ â†’ COâ‚‚ + 2Hâ‚‚O + heat','rx');
        log('Exothermic! Bright visible flame.','w');
        startBoiling();
        let t=25;
        const iv=setInterval(()=>{
          t=Math.min(860,t+22);
          document.getElementById('phdisp').innerHTML = `COMBUSTION | ${Math.round(t)}Â°C`;
          if(t>=860){ 
            clearInterval(iv); 
            log('Peak flame temp: ~860Â°C','w');
          }
        },100);
        tmrs.push(iv);
        S.ignited=true; rb();
      }
    },
    { lbl:'ðŸ§ª Collect COâ‚‚', cls:'g', req:'ignited',
      run(){
        setLiq('cyl_liq', 68, 'linear-gradient(rgba(180,200,175,.4),rgba(140,160,135,.7))');
        log('COâ‚‚ collected via downward displacement.','s');
        log('Reading: 250 mL COâ‚‚ collected.','s');
      }
    },
    { lbl:'ðŸ’§ Test with Limewater', cls:'b', req:'ignited',
      run(){
        setLiq('ttl2', 65, 'linear-gradient(rgba(230,230,220,.5),rgba(200,200,180,.85))');
        log('COâ‚‚ + Ca(OH)â‚‚ â†’ CaCOâ‚ƒâ†“ + Hâ‚‚O','rx');
        log('âœ… Milky white precipitate confirms COâ‚‚!','s');
      }
    },
    { lbl:'â†º Reset Lab', cls:'x', run(){ resetLab(); } }
  ]},
  { name:'Weak Acid Titration', steps:[
    { lbl:'ðŸ”µ Fill Burette (NaOH)', cls:'b',
      run(){
        setLiq('cyl_liq', 90, 'linear-gradient(rgba(0,150,255,.45),rgba(0,100,200,.82))');
        log('Burette filled with 0.1M NaOH solution.','h');
        S.burette=true; rb();
      }
    },
    { lbl:'ðŸ”´ Add Acetic Acid 25mL', cls:'r', req:'burette',
      run(){
        setLiq('flask_liq', 40, 'linear-gradient(rgba(255,200,80,.55),rgba(220,150,20,.88))');
        setLiq('beaker_liq', 34, 'linear-gradient(rgba(255,200,80,.5),rgba(220,150,20,.82))');
        setPH(3.5);
        log('25 mL of 0.1M CHâ‚ƒCOOH added.','h');
        S.acid2=true; rb();
      }
    },
    { lbl:'ðŸ’œ Add Indicator', cls:'p', req:'acid2',
      run(){
        setLiq('flask_liq', 40, 'linear-gradient(rgba(255,140,180,.55),rgba(220,60,100,.88))');
        log('Phenolphthalein added (colourless in acid).','rx');
        S.indic=true; rb();
      }
    },
    { lbl:'âž• Run Titration (live)', cls:'b', req:'acid2',
      run(){
        log('Dripping NaOH from burette...','h');
        let vol=0;
        const iv=setInterval(()=>{
          vol+=0.5;
          const ph=Math.min(3.5+(vol/50)*9,11);
          setPH(ph);
          const cy=Math.max(8,90-(vol*1.6));
          setLiq('cyl_liq', cy, 'linear-gradient(rgba(0,150,255,.45),rgba(0,100,200,.82))');
          document.getElementById('phdisp').innerHTML = `pH: ${ph.toFixed(1)} | NaOH: ${vol.toFixed(1)} mL`;
          if(vol>=25){
            clearInterval(iv);
            doFlash('flask_flash');
            setLiq('flask_liq', 55, 'linear-gradient(rgba(255,100,200,.65),rgba(220,30,150,.92))');
            setLiq('beaker_liq', 54, 'linear-gradient(rgba(255,100,200,.55),rgba(200,20,130,.88))');
            setPH(8.7);
            log('âœ… Equivalence point! V = 25.0 mL NaOH','s');
            log('CHâ‚ƒCOOH + NaOH â†’ CHâ‚ƒCOONa + Hâ‚‚O','rx');
          }
        },180);
        tmrs.push(iv);
      }
    },
    { lbl:'â†º Reset Lab', cls:'x', run(){ resetLab(); } }
  ]},
  { name:'Redox Reaction', steps:[
    { lbl:'ðŸŸ£ Add KMnOâ‚„', cls:'p',
      run(){
        setLiq('flask_liq', 40, 'linear-gradient(rgba(160,60,255,.65),rgba(100,10,200,.92))');
        setLiq('beaker_liq', 34, 'linear-gradient(rgba(160,60,255,.58),rgba(100,10,200,.88))');
        setLiq('ttl3', 55, 'linear-gradient(rgba(180,80,255,.65),rgba(120,20,220,.95))');
        setPH(1);
        log('KMnOâ‚„ (deep purple) added as oxidising agent.','rx');
        S.kmno4=true; rb();
      }
    },
    { lbl:'âšª Add Hâ‚‚Oâ‚‚ (Reductant)', cls:'b', req:'kmno4',
      run(){
        log('Adding Hâ‚‚Oâ‚‚ dropwise...','h');
        let step=0;
        const iv=setInterval(()=>{
          step++;
          if(step===1){ 
            log('Vigorous bubbling! Oâ‚‚ gas evolving.','rx'); 
            startBoiling(); 
          }
          if(step===3){
            setLiq('flask_liq', 50, 'linear-gradient(rgba(180,160,135,.55),rgba(120,98,72,.88))');
            setLiq('beaker_liq', 50, 'linear-gradient(rgba(180,160,135,.5),rgba(120,98,72,.82))');
            log('Purple fading â†’ brown MnOâ‚‚ precipitate!','rx');
          }
          if(step===6){
            clearInterval(iv);
            doFlash('flask_flash');
            setLiq('flask_liq', 54, 'linear-gradient(rgba(200,175,138,.45),rgba(140,108,58,.88))');
            log('âœ… KMnOâ‚„ fully reduced to MnOâ‚‚.','s');
            log('2KMnOâ‚„ + 5Hâ‚‚Oâ‚‚ + 3Hâ‚‚SOâ‚„ â†’ 2MnSOâ‚„ + 5Oâ‚‚â†‘ + 8Hâ‚‚O','rx');
            setPH(3);
          }
        },560);
        tmrs.push(iv);
        S.h2o2=true; rb();
      }
    },
    { lbl:'ðŸŒ¡ Monitor Temperature', cls:'o', req:'kmno4',
      run(){
        log('Thermometer inserted...','h');
        let t=22;
        const iv=setInterval(()=>{
          t+=1.4;
          document.getElementById('phdisp').innerHTML = `REDOX | ${t.toFixed(1)}Â°C`;
          if(t>=38){ 
            clearInterval(iv); 
            log(`Peak: ${t.toFixed(1)}Â°C â€” mildly exothermic.`,'w');
          }
        },140);
        tmrs.push(iv);
      }
    },
    { lbl:'â†º Reset Lab', cls:'x', run(){ resetLab(); } }
  ]}
];

/* =============================================
   UI CONTROLS
   ============================================= */
function rb(){
  const exp = EXPS[curExp];
  const area = document.getElementById('btns');
  area.innerHTML = '';
  exp.steps.forEach(step => {
    const b = document.createElement('button');
    b.className = 'lbtn ' + step.cls;
    b.textContent = step.lbl;
    if(step.req && !S[step.req]) b.disabled = true;
    b.onclick = () => step.run();
    area.appendChild(b);
  });
}

function selExp(idx, el){
  document.querySelectorAll('.eopt').forEach(e => e.classList.remove('act'));
  el.classList.add('act');
  curExp = idx;
  resetLab(false);
  log(`--- ${EXPS[idx].name} ---`,'h');
  rb();
}

function resetLab(addLog = true){
  clearTmrs();
  flameOn(false);
  stopBoiling();
  S = {};
  
  setLiq('flask_liq', 0);
  setLiq('beaker_liq', 0);
  setLiq('cyl_liq', 38, 'linear-gradient(rgba(0,150,255,.42),rgba(0,100,200,.78))');
  
  ['ttl0','ttl1','ttl2','ttl3'].forEach((id,i)=>{
    const bgs = [
      'linear-gradient(rgba(255,80,80,.5),rgba(200,30,30,.9))',
      'linear-gradient(rgba(80,180,255,.5),rgba(0,130,220,.9))',
      'linear-gradient(rgba(80,220,130,.5),rgba(0,170,80,.9))',
      'linear-gradient(rgba(200,140,255,.5),rgba(140,50,220,.9))'
    ];
    const hs = [42,54,37,50];
    setLiq(id, hs[i], bgs[i]);
  });
  
  setPH(null);
  if(addLog) log('Lab reset. Ready.','');
  rb();
}

/* =============================================
   ANIMATION LOOP
   ============================================= */
function animate() {
  requestAnimationFrame(animate);
  drawRoom();
}

/* =============================================
   INITIALIZATION
   ============================================= */
window.addEventListener('resize', ()=>{
  resizeCanvas();
  setTimeout(positionFlame, 100);
});

resizeCanvas();
setTimeout(positionFlame, 200);

// Start animation loop
animate();

// Add custom CSS animations
const style = document.createElement('style');
style.textContent = `
  @keyframes standPulse { 0%,100%{opacity:1;} 50%{opacity:0.8;} }
  @keyframes clampRotate { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
  @keyframes rodVibrate { from{transform:rotate(12deg);} to{transform:rotate(14deg);} }
  @keyframes cylinderShine { 0%{transform:translateX(-100%);} 100%{transform:translateX(100%);} }
  @keyframes bottleCap { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-2px);} }
  @keyframes tubeWobble { from{transform:rotate(-1deg);} to{transform:rotate(1deg);} }
`;
document.head.appendChild(style);

log(`--- ${EXPS[0].name} ---`,'h');
log('Welcome to the 3D Chemistry Lab!','h');
log('Click a control step to begin the experiment.','');
setPH(null);
rb();
</script>
</body>
</html>
